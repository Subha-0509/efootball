<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Efootball Tournament Platform by PesPagol</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Tailwind config -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50: '#e6f7ff',
              100: '#b3ecff',
              200: '#80e1ff',
              300: '#4dd5ff',
              400: '#1ac9ff',   /* electric blue */
              500: '#00a7e6',
              600: '#007fb4',
              700: '#005982',
              800: '#003251',
              900: '#001426'
            },
            neon: {
              yellow: '#ffe600'
            }
          },
          boxShadow: {
            'brand-glow': '0 0 25px rgba(0,199,255,0.45)',
            'card-soft': '0 18px 40px rgba(0,0,0,0.55)'
          },
          fontFamily: {
            sans: ['system-ui', 'Segoe UI', 'sans-serif']
          }
        }
      }
    };
  </script>

  <!-- Background + extra styles -->
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at top left, rgba(26,201,255,0.2), transparent 55%),
        radial-gradient(circle at bottom right, rgba(255,230,0,0.15), transparent 55%),
        linear-gradient(135deg, #020617 0%, #020617 40%, #020617 100%),
        url('bg_efootball.jpg') center/cover no-repeat fixed;
      background-blend-mode: screen, screen, multiply, normal;
    }

    .card-hover {
      transition:
        transform 0.18s ease-out,
        box-shadow 0.18s ease-out,
        border-color 0.18s ease-out,
        background-color 0.18s ease-out;
    }

    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 18px 40px rgba(0,0,0,0.6);
      border-color: rgba(26,201,255,0.4);
      background-color: rgba(15,23,42,0.96);
    }

    .btn-glow {
      transition:
        transform 0.16s ease-out,
        box-shadow 0.16s ease-out,
        background-color 0.16s ease-out;
    }

    .btn-glow:hover {
      transform: translateY(-1px);
      box-shadow: 0 0 18px rgba(0,199,255,0.6);
    }

    /* Simple loader animation */
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loader-ring {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      border-width: 3px;
      border-style: solid;
      border-color: rgba(148,163,184,0.3);
      border-top-color: #1ac9ff;
      animation: spin 0.9s linear infinite;
    }
  </style>
</head>
<body class="text-slate-50 min-h-screen flex flex-col">

  <!-- GLOBAL LOADER -->
  <div id="globalLoader"
       class="hidden fixed inset-0 z-50 bg-slate-950/90 backdrop-blur-md flex flex-col items-center justify-center gap-3">
    <div class="loader-ring"></div>
    <p class="text-xs text-slate-300 tracking-wide uppercase">
      Syncing with PesPagol servers...
    </p>
  </div>

  <!-- TOP NAV -->
  <nav class="border-b border-slate-800/80 bg-slate-950/80 backdrop-blur-xl sticky top-0 z-30">
    <div class="max-w-6xl mx-auto px-4 py-2.5 flex items-center justify-between gap-3">
      <div class="flex items-center gap-2">
        <div class="relative">
          <div class="absolute inset-0 rounded-2xl blur-lg bg-brand-400/50 opacity-60"></div>
          <img src="pespagol_logo.png"
               alt="PesPagol logo"
               class="relative w-10 h-10 sm:w-11 sm:h-11 object-contain" />
        </div>
        <div class="flex flex-col leading-tight">
          <span class="text-xs uppercase tracking-[0.28em] text-slate-400">
            PesPagol
          </span>
          <span class="text-[13px] sm:text-sm font-semibold tracking-tight text-slate-50">
            Efootball Tournament Platform
          </span>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <span id="headerModeTag"
              class="hidden sm:inline-flex items-center gap-1 rounded-full border border-slate-700/70 bg-slate-900/80 px-2.5 py-1 text-[10px] text-slate-300">
        </span>
        <button id="logoutBtn"
                class="hidden text-[11px] px-3 py-1.5 rounded-full border border-slate-700 bg-slate-900 hover:bg-slate-800 text-slate-200">
          Logout
        </button>
      </div>
    </div>
  </nav>

  <!-- MAIN -->
  <main class="flex-1 max-w-6xl mx-auto px-4 py-6 sm:py-8">

    <!-- HERO SECTION (organiser, not logged in) -->
    <section id="heroSection"
             class="hidden mb-7 sm:mb-10">
      <div class="grid md:grid-cols-2 gap-6 items-center">
        <!-- Left: text -->
        <div class="space-y-3 sm:space-y-4">
          <div class="inline-flex items-center gap-2 rounded-full border border-brand-400/40 bg-brand-400/10 px-3 py-1">
            <span class="h-1.5 w-1.5 rounded-full bg-emerald-400"></span>
            <span class="text-[10px] tracking-[0.25em] uppercase text-brand-200">
              Efootball · Online & LAN
            </span>
          </div>
          <h1 class="text-2xl sm:text-3xl md:text-4xl font-semibold tracking-tight text-slate-50">
            Run your next
            <span class="text-brand-300">Efootball</span> tournament
            like a pro.
          </h1>
          <p class="text-xs sm:text-sm text-slate-300 max-w-md">
            Create tournaments, share one link, let players or teams book their spots,
            and track matches & standings — all in one clean esports dashboard.
          </p>

          <div class="flex flex-wrap items-center gap-3 pt-1">
            <button id="heroPrimaryBtn"
                    class="inline-flex items-center gap-2 rounded-full bg-brand-400 hover:bg-brand-300 text-slate-950 font-semibold text-xs sm:text-sm px-4 sm:px-5 py-2 shadow-brand-glow btn-glow">
              <span>+ Create Tournament</span>
            </button>
            <button id="heroSecondaryBtn"
                    class="inline-flex items-center gap-2 rounded-full border border-slate-700 bg-slate-900/80 hover:bg-slate-800 text-[11px] sm:text-xs text-slate-200 px-4 py-2">
              <span>View Example Layout</span>
            </button>
          </div>

          <div class="flex flex-wrap gap-4 text-[10px] text-slate-400 pt-1">
            <div class="flex items-center gap-1.5">
              <span class="h-1.5 w-1.5 rounded-full bg-brand-400"></span>
              <span>1v1 · 2v2 · 3v3 support</span>
            </div>
            <div class="flex items-center gap-1.5">
              <span class="h-1.5 w-1.5 rounded-full bg-brand-400"></span>
              <span>League · Knockout · Groups</span>
            </div>
            <div class="flex items-center gap-1.5">
              <span class="h-1.5 w-1.5 rounded-full bg-brand-400"></span>
              <span>Player/Team join via link</span>
            </div>
          </div>
        </div>

        <!-- Right: glow panel -->
        <div class="relative">
          <div class="absolute -inset-4 bg-gradient-to-tr from-brand-400/20 via-slate-900/0 to-neon-yellow/20 blur-2xl opacity-70"></div>
          <div class="relative bg-slate-950/90 border border-slate-800/80 rounded-3xl p-4 sm:p-5 shadow-card-soft card-hover">
            <div class="text-[10px] uppercase tracking-[0.20em] text-slate-500 mb-1">
              Quick glance
            </div>
            <div class="flex items-center justify-between mb-3">
              <div>
                <div class="text-sm font-semibold text-slate-50">Tournament Snapshot</div>
                <div class="text-[11px] text-slate-400">Example dashboard overview</div>
              </div>
              <span class="text-[11px] text-brand-200 bg-brand-400/10 border border-brand-400/50 rounded-full px-2 py-1">
                Live style
              </span>
            </div>
            <div class="grid grid-cols-3 gap-2 text-[11px] mb-4">
              <div class="rounded-xl bg-slate-900/90 border border-slate-800 px-2 py-2">
                <div class="text-slate-400">Players</div>
                <div class="text-lg font-semibold text-brand-200">32</div>
              </div>
              <div class="rounded-xl bg-slate-900/90 border border-slate-800 px-2 py-2">
                <div class="text-slate-400">Matches</div>
                <div class="text-lg font-semibold text-slate-50">48</div>
              </div>
              <div class="rounded-xl bg-slate-900/90 border border-slate-800 px-2 py-2">
                <div class="text-slate-400">Mode</div>
                <div class="text-[11px] font-semibold text-neon-yellow">Groups + KO</div>
              </div>
            </div>
            <div class="rounded-xl bg-slate-900/90 border border-slate-800 px-3 py-2.5 space-y-1.5">
              <div class="flex justify-between text-[11px] text-slate-300">
                <span>Top Player</span><span class="text-brand-200">EFP_GODLIKE</span>
              </div>
              <div class="flex justify-between text-[11px] text-slate-300">
                <span>Current Stage</span><span class="text-slate-100">Group Stage · R3</span>
              </div>
              <div class="flex justify-between text-[11px] text-slate-300">
                <span>Next Fixture</span><span class="text-slate-100">Tonight · 9:30 PM</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- AUTH SECTION -->
    <section id="authSection"
             class="hidden max-w-md mx-auto bg-slate-950/90 border border-slate-800/80 rounded-2xl shadow-card-soft p-5 sm:p-6 card-hover">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h2 class="text-lg font-semibold tracking-tight flex items-center gap-2">
            <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-brand-400/10 border border-brand-400/50 text-[11px] text-brand-200">01</span>
            Organiser Login
          </h2>
          <p class="text-xs text-slate-400 mt-1">
            Sign in or create an account to manage your eFootball tournaments.
          </p>
        </div>
        <span class="inline-flex items-center gap-1 rounded-full bg-emerald-500/10 border border-emerald-400/40 px-2 py-1 text-[10px] text-emerald-200">
          <span class="h-1.5 w-1.5 rounded-full bg-emerald-400"></span>
          Organiser Only
        </span>
      </div>

      <!-- Login / Signup toggle -->
      <div class="flex text-[11px] mb-4 gap-1.5 bg-slate-900/80 rounded-xl p-1 border border-slate-800/80">
        <button id="loginTab"
                class="flex-1 px-3 py-1.5 rounded-lg bg-slate-800 border border-slate-700 font-semibold text-slate-50">
          Login
        </button>
        <button id="signupTab"
                class="flex-1 px-3 py-1.5 rounded-lg text-slate-300">
          Signup
        </button>
      </div>

      <form id="authForm" class="space-y-3 text-xs">
        <div>
          <label class="block text-slate-300 mb-1">Email</label>
          <input id="authEmail" type="email" required
                 class="w-full rounded-xl bg-slate-950 border border-slate-800/80 px-3 py-2 text-xs focus:outline-none focus:ring-1 focus:ring-brand-400 focus:border-brand-400" />
        </div>
        <div>
          <label class="block text-slate-300 mb-1">Password</label>
          <input id="authPassword" type="password" required
                 class="w-full rounded-xl bg-slate-950 border border-slate-800/80 px-3 py-2 text-xs focus:outline-none focus:ring-1 focus:ring-brand-400 focus:border-brand-400" />
        </div>
        <p id="authError" class="text-xs text-red-300 min-h-[1.25rem]"></p>
        <button type="submit"
                class="w-full rounded-xl bg-brand-400 hover:bg-brand-300 text-slate-950 font-semibold py-2.5 text-xs sm:text-sm shadow-brand-glow btn-glow">
          Continue
        </button>
        <p class="text-[10px] text-slate-400 mt-2">
          Players don't need accounts. They can join using the tournament link shared by the organiser.
        </p>
      </form>
    </section>

    <!-- ORGANISER SECTION -->
    <section id="organiserSection" class="hidden">
      <div class="grid lg:grid-cols-3 gap-5">

        <!-- CREATE TOURNAMENT -->
        <div class="lg:col-span-1">
          <div class="bg-slate-950/90 border border-slate-800/80 rounded-2xl shadow-card-soft p-4 sm:p-5 flex flex-col card-hover">
            <div class="flex items-center justify-between mb-3">
              <div>
                <h2 class="text-base font-semibold flex items-center gap-2">
                  <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-brand-400/10 border border-brand-400/60 text-[11px] text-brand-200">01</span>
                  Create Tournament
                </h2>
                <p class="text-[11px] text-slate-400 mt-1">
                  Choose platform, mode and format for your eFootball event.
                </p>
              </div>
              <div class="hidden sm:flex flex-col items-end text-[10px] text-slate-400">
                <span class="uppercase tracking-[0.20em] text-slate-500">Step</span>
                <span class="text-neon-yellow font-semibold">01 / 03</span>
              </div>
            </div>

            <form id="createTournamentForm" class="space-y-3 text-[11px] sm:text-xs flex-1">
              <div>
                <label class="block text-slate-300 mb-1">Tournament Name</label>
                <input id="tName" type="text" required
                       placeholder="e.g. Efootball Mobile Cup S1"
                       class="w-full rounded-xl bg-slate-950 border border-slate-800/80 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-brand-400 focus:border-brand-400" />
              </div>

              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="block text-slate-300 mb-1">Platform</label>
                  <select id="tPlatform"
                          class="w-full rounded-xl bg-slate-950 border border-slate-800/80 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-brand-400">
                    <option value="PS">PlayStation</option>
                    <option value="Xbox">Xbox</option>
                    <option value="PC">PC</option>
                    <option value="Mobile" selected>Mobile</option>
                  </select>
                </div>
                <div>
                  <label class="block text-slate-300 mb-1">Mode</label>
                  <select id="tMode"
                          class="w-full rounded-xl bg-slate-950 border border-slate-800/80 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-brand-400">
                    <option value="1v1">1v1 (Players)</option>
                    <option value="2v2">2v2 (Teams)</option>
                    <option value="3v3">3v3 (Teams)</option>
                  </select>
                </div>
              </div>

              <div>
                <label class="block text-slate-300 mb-1">Tournament Type</label>
                <select id="tType"
                        class="w-full rounded-xl bg-slate-950 border border-slate-800/80 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-brand-400">
                  <option value="league">League</option>
                  <option value="knockout">Knockout</option>
                  <option value="groups_knockout">Groups + Knockout</option>
                </select>
              </div>

              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="block text-slate-300 mb-1">Start Date</label>
                  <input id="tStart" type="date"
                         class="w-full rounded-xl bg-slate-950 border border-slate-800/80 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-brand-400" />
                </div>
                <div>
                  <label class="block text-slate-300 mb-1">Max Participants</label>
                  <input id="tMaxPlayers" type="number" min="2" max="128" value="16"
                         class="w-full rounded-xl bg-slate-950 border border-slate-800/80 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-brand-400" />
                </div>
              </div>

              <div>
                <label class="block text-slate-300 mb-1">Notes (optional)</label>
                <textarea id="tNotes" rows="2"
                          placeholder="Rules, time, prize pool, WhatsApp group link, etc."
                          class="w-full rounded-xl bg-slate-950 border border-slate-800/80 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-brand-400"></textarea>
              </div>

              <button type="submit"
                      class="w-full rounded-xl bg-brand-400 hover:bg-brand-300 text-slate-950 font-semibold py-2.5 text-xs sm:text-sm shadow-brand-glow mt-1 btn-glow">
                + Create Tournament
              </button>
            </form>
          </div>
        </div>

        <!-- TOURNAMENT LIST + DETAIL -->
        <div class="lg:col-span-2 space-y-5">

          <!-- LIST -->
          <div class="bg-slate-950/90 border border-slate-800/80 rounded-2xl shadow-card-soft p-4 sm:p-5 card-hover">
            <div class="flex items-center justify-between mb-3">
              <div>
                <h2 class="text-base font-semibold flex items-center gap-2">
                  <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-brand-400/10 border border-brand-400/60 text-[11px] text-brand-200">02</span>
                  Your Tournaments
                </h2>
                <p class="text-[11px] text-slate-400 mt-1">
                  Open a tournament to view players, matches and standings.
                </p>
              </div>
              <div class="hidden sm:block text-[10px] text-slate-500 uppercase tracking-[0.18em]">
                Dashboard
              </div>
            </div>
            <div id="tournamentList" class="space-y-3 text-sm"></div>
          </div>

          <!-- DETAIL -->
          <div class="bg-slate-950/90 border border-slate-800/80 rounded-2xl shadow-card-soft p-4 sm:p-5 card-hover">
            <h2 class="text-base font-semibold flex items-center gap-2 mb-3">
              <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-brand-400/10 border border-brand-400/60 text-[11px] text-brand-200">03</span>
              Tournament Details
            </h2>
            <div id="tournamentDetail" class="text-sm text-slate-300">
              <p class="text-xs text-slate-400">
                Select a tournament on the left to see overview, players, match center and standings.
              </p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- PUBLIC VIEW / JOIN SECTION -->
    <section id="publicSection" class="hidden">
      <div class="bg-slate-950/92 border border-slate-800/80 rounded-2xl shadow-card-soft p-4 sm:p-5 card-hover">
        <div id="publicTournamentInfo" class="mb-4 text-sm text-slate-200">
          Loading tournament...
        </div>
        <div id="publicModeContent" class="space-y-4 text-sm"></div>
      </div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="border-t border-slate-800/80 bg-slate-950/90">
    <div class="max-w-6xl mx-auto px-4 py-3 flex flex-col sm:flex-row items-center justify-between gap-2">
      <p class="text-[10px] text-slate-500 text-center sm:text-left">
        Powered by <span class="text-slate-200 font-medium">PesPagol</span> · Efootball Tournament Platform
      </p>
      <p class="text-[10px] text-slate-500 text-center sm:text-right">
        1v1 · 2v2 · 3v3 · League · Knockout · Groups + Knockout
      </p>
    </div>
  </footer>

  <!-- EDIT POPUP -->
  <section id="editPage"
           class="hidden fixed inset-0 bg-slate-950/95 backdrop-blur-xl z-40 p-4 sm:p-6 flex items-center justify-center">
    <div class="max-w-lg w-full bg-slate-950/95 border border-slate-800/80 rounded-2xl p-5 sm:p-6 shadow-card-soft card-hover">
      <h2 class="text-lg font-bold text-slate-100 mb-3 flex items-center gap-2">
        <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-brand-400/10 border border-brand-400/60 text-[11px] text-brand-200">Edit</span>
        Tournament
      </h2>
      <form id="editTournamentForm" class="space-y-3 text-xs sm:text-sm">
        <div>
          <label class="block text-slate-300 mb-1">Tournament Name</label>
          <input id="edit_tName" type="text"
                 class="w-full rounded-xl bg-slate-950 border border-slate-800/80 px-3 py-2" />
        </div>
        <div>
          <label class="block text-slate-300 mb-1">Notes</label>
          <textarea id="edit_tNotes" rows="2"
                    class="w-full rounded-xl bg-slate-950 border border-slate-800/80 px-3 py-2"></textarea>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-slate-300 mb-1">Start Date</label>
            <input id="edit_tStart" type="date"
                   class="w-full rounded-xl bg-slate-950 border border-slate-800/80 px-3 py-2" />
          </div>
          <div>
            <label class="block text-slate-300 mb-1">Max Participants</label>
            <input id="edit_tMax" type="number"
                   class="w-full rounded-xl bg-slate-950 border border-slate-800/80 px-3 py-2" />
          </div>
        </div>
        <div class="flex items-center justify-between mt-4 gap-3">
          <button type="button" id="editCancelBtn"
                  class="w-1/2 px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-200 text-xs sm:text-sm">
            Cancel
          </button>
          <button type="submit"
                  class="w-1/2 px-4 py-2 rounded-xl bg-brand-400 hover:bg-brand-300 text-slate-950 font-semibold text-xs sm:text-sm btn-glow">
            Save Changes
          </button>
        </div>
      </form>
    </div>
  </section>

  <!-- APP SCRIPT -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      doc,
      addDoc,
      getDoc,
      getDocs,
      query,
      where,
      orderBy,
      serverTimestamp,
      updateDoc,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBJmw5rvmN3DrDBUveGZlqHU3j-xmjKYSI",
      authDomain: "pes-tournament-e2a1a.firebaseapp.com",
      databaseURL: "https://pes-tournament-e2a1a-default-rtdb.firebaseio.com",
      projectId: "pes-tournament-e2a1a",
      storageBucket: "pes-tournament-e2a1a.firebasestorage.app",
      messagingSenderId: "966089960191",
      appId: "1:966089960191:web:bb61b49290e09585b27aca",
      measurementId: "G-YDWWJRZCNR"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Mode detection
    const params = new URLSearchParams(window.location.search);
    const viewId = params.get("view");
    const joinId = params.get("join");
    const mode = viewId ? "view" : joinId ? "join" : "organiser";

    // DOM refs
    const headerModeTag = document.getElementById("headerModeTag");
    const logoutBtn = document.getElementById("logoutBtn");
    const heroSection = document.getElementById("heroSection");
    const heroPrimaryBtn = document.getElementById("heroPrimaryBtn");
    const heroSecondaryBtn = document.getElementById("heroSecondaryBtn");
    const globalLoader = document.getElementById("globalLoader");

    const authSection = document.getElementById("authSection");
    const organiserSection = document.getElementById("organiserSection");
    const publicSection = document.getElementById("publicSection");
    const editPage = document.getElementById("editPage");
    const editTournamentForm = document.getElementById("editTournamentForm");
    const editCancelBtn = document.getElementById("editCancelBtn");

    const loginTab = document.getElementById("loginTab");
    const signupTab = document.getElementById("signupTab");
    const authForm = document.getElementById("authForm");
    const authEmail = document.getElementById("authEmail");
    const authPassword = document.getElementById("authPassword");
    const authError = document.getElementById("authError");

    const createTournamentForm = document.getElementById("createTournamentForm");
    const tournamentListEl = document.getElementById("tournamentList");
    const tournamentDetailEl = document.getElementById("tournamentDetail");

    const publicTournamentInfo = document.getElementById("publicTournamentInfo");
    const publicModeContent = document.getElementById("publicModeContent");

    let authMode = "login";
    let currentUser = null;
    let selectedTournamentId = null;
    let currentTournaments = [];
    let currentEditId = null;
    let currentEditTournamentData = null;

    // Loader helpers
    function showLoader() {
      if (globalLoader) globalLoader.classList.remove("hidden");
    }
    function hideLoader() {
      if (globalLoader) globalLoader.classList.add("hidden");
    }

    // Mode header text
    if (mode === "organiser") {
      headerModeTag.classList.remove("hidden");
      headerModeTag.textContent = "Organiser Panel · Create & manage tournaments";
    } else if (mode === "view") {
      headerModeTag.classList.remove("hidden");
      headerModeTag.textContent = "Public View · Live tournament page";
    } else if (mode === "join") {
      headerModeTag.classList.remove("hidden");
      headerModeTag.textContent = "Player Join · Book your spot";
    }

    // Hero buttons
    if (heroPrimaryBtn) {
      heroPrimaryBtn.addEventListener("click", () => {
        if (mode !== "organiser") return;
        if (currentUser) {
          createTournamentForm?.scrollIntoView({ behavior: "smooth", block: "start" });
        } else {
          authSection?.scrollIntoView({ behavior: "smooth", block: "start" });
        }
      });
    }

    if (heroSecondaryBtn) {
      heroSecondaryBtn.addEventListener("click", () => {
        if (mode !== "organiser") return;
        authSection?.scrollIntoView({ behavior: "smooth", block: "nearest" });
      });
    }

    // Auth UI switching
    function setAuthMode(newMode) {
      authMode = newMode;
      if (newMode === "login") {
        loginTab.classList.add("bg-slate-800", "border", "border-slate-700", "font-semibold", "text-slate-50");
        signupTab.classList.remove("bg-slate-800", "border", "border-slate-700", "font-semibold", "text-slate-50");
        signupTab.classList.add("text-slate-300");
      } else {
        signupTab.classList.add("bg-slate-800", "border", "border-slate-700", "font-semibold", "text-slate-50");
        loginTab.classList.remove("bg-slate-800", "border", "border-slate-700", "font-semibold", "text-slate-50");
        loginTab.classList.add("text-slate-300");
      }
      authError.textContent = "";
    }

    loginTab.addEventListener("click", () => setAuthMode("login"));
    signupTab.addEventListener("click", () => setAuthMode("signup"));

    // Auth form submit
    authForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      authError.textContent = "";
      const email = authEmail.value.trim();
      const password = authPassword.value.trim();
      try {
        showLoader();
        if (authMode === "login") {
          await signInWithEmailAndPassword(auth, email, password);
        } else {
          await createUserWithEmailAndPassword(auth, email, password);
        }
      } catch (err) {
        authError.textContent = err.message || "Authentication error";
      } finally {
        hideLoader();
      }
    });

    logoutBtn.addEventListener("click", async () => {
      showLoader();
      await signOut(auth);
      hideLoader();
    });

    // Load organiser tournaments
    async function loadTournamentsForUser(userId) {
      showLoader();
      try {
        const q = query(
          collection(db, "tournaments"),
          where("ownerUid", "==", userId),
          orderBy("createdAt", "desc")
        );
        const snap = await getDocs(q);
        currentTournaments = [];
        snap.forEach(docSnap => {
          currentTournaments.push({ id: docSnap.id, ...docSnap.data() });
        });
        renderTournamentList();
      } finally {
        hideLoader();
      }
    }

    function renderTournamentList() {
      tournamentListEl.innerHTML = "";
      if (currentTournaments.length === 0) {
        tournamentListEl.innerHTML =
          '<p class="text-slate-400 text-xs sm:text-sm">No tournaments yet. Create your first eFootball event on the left.</p>';
        return;
      }

      currentTournaments.forEach(t => {
        const participantsCount = t.mode === "1v1"
          ? (t.playerCount || 0)
          : (t.teamCount || 0);

        const wrapper = document.createElement("div");
        wrapper.className =
          "rounded-2xl border border-slate-800/80 bg-slate-950/80 px-3 py-3 sm:px-4 sm:py-3 flex flex-col sm:flex-row sm:items-start sm:justify-between gap-2 sm:gap-3 card-hover";

        const typeLabel =
          t.type === "league" ? "League" :
          t.type === "knockout" ? "Knockout" :
          t.type === "groups_knockout" ? "Groups + Knockout" :
          t.type;

        wrapper.innerHTML = `
          <div class="min-w-0">
            <div class="font-semibold text-slate-50 text-sm sm:text-base truncate flex items-center gap-1.5">
              <span class="inline-flex h-1.5 w-1.5 rounded-full bg-brand-400"></span>
              <span class="truncate">${t.name}</span>
            </div>
            <div class="text-[11px] sm:text-xs text-slate-400 mt-0.5 sm:mt-1 flex flex-wrap gap-x-2 gap-y-0.5">
              <span>${t.platform}</span>
              <span>• ${t.mode}</span>
              <span>• ${typeLabel}</span>
              ${t.startDate ? `<span>• Starts ${t.startDate}</span>` : ""}
            </div>
            <div class="text-[11px] text-slate-500 mt-1">
              ${(t.mode === "1v1" ? "Players" : "Teams")}: ${participantsCount}
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button class="btn-open px-3 py-1.5 rounded-full bg-brand-400 hover:bg-brand-300 text-slate-950 text-[11px] font-semibold shadow-brand-glow btn-glow">
              Open
            </button>
            <button class="btn-edit px-3 py-1.5 rounded-full bg-slate-800 hover:bg-slate-700 text-slate-50 text-[11px] font-semibold">
              Edit
            </button>
            <button class="btn-delete px-3 py-1.5 rounded-full bg-red-500/80 hover:bg-red-500 text-slate-50 text-[11px] font-semibold">
              Delete
            </button>
          </div>
        `;

        wrapper.querySelector(".btn-open").addEventListener("click", () => {
          selectedTournamentId = t.id;
          renderTournamentDetail();
        });

        wrapper.querySelector(".btn-edit").addEventListener("click", () => {
          openEditPage(t);
        });

        wrapper.querySelector(".btn-delete").addEventListener("click", async () => {
          const sure = confirm("Are you sure you want to delete this tournament? This cannot be undone.");
          if (!sure) return;
          showLoader();
          try {
            await deleteTournament(t.id);
            await loadTournamentsForUser(currentUser.uid);
            tournamentDetailEl.innerHTML = "<p class='text-xs text-slate-400'>Select a tournament.</p>";
          } finally {
            hideLoader();
          }
        });

        tournamentListEl.appendChild(wrapper);
      });
    }

    // Delete tournament + subcollections
    async function deleteTournament(tId) {
      const tRef = doc(db, "tournaments", tId);

      async function deleteSub(path) {
        const colRef = collection(db, "tournaments", tId, path);
        const snap = await getDocs(colRef);
        for (const d of snap.docs) {
          await deleteDoc(doc(db, "tournaments", tId, path, d.id));
        }
      }

      await deleteSub("players");
      await deleteSub("teams");
      await deleteSub("matches");
      await deleteDoc(tRef);
    }

    // Edit tournament
    async function editTournament(tId, newData) {
      const tRef = doc(db, "tournaments", tId);
      await updateDoc(tRef, newData);
    }

    function openEditPage(t) {
      currentEditId = t.id;
      currentEditTournamentData = t;
      document.getElementById("edit_tName").value = t.name || "";
      document.getElementById("edit_tNotes").value = t.notes || "";
      document.getElementById("edit_tStart").value = t.startDate || "";
      document.getElementById("edit_tMax").value = t.maxParticipants || "";
      editPage.classList.remove("hidden");
    }

    editCancelBtn.addEventListener("click", () => {
      editPage.classList.add("hidden");
    });

    editTournamentForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentEditId || !currentUser) return;

      const newData = {
        name: document.getElementById("edit_tName").value.trim(),
        notes: document.getElementById("edit_tNotes").value.trim(),
        startDate: document.getElementById("edit_tStart").value || null,
        maxParticipants: Number(document.getElementById("edit_tMax").value) || null
      };

      showLoader();
      try {
        await editTournament(currentEditId, newData);
        alert("Tournament updated successfully!");
        editPage.classList.add("hidden");
        await loadTournamentsForUser(currentUser.uid);
        if (selectedTournamentId === currentEditId) {
          await renderTournamentDetail();
        }
      } finally {
        hideLoader();
      }
    });

    // Tabs helper
    function setActiveTab(buttons, active, panels) {
      buttons.forEach(btn => {
        const tab = btn.getAttribute("data-tab");
        if (tab === active) {
          btn.classList.add("border-b-2", "border-brand-400", "text-brand-200");
          btn.classList.remove("border-transparent", "text-slate-400");
        } else {
          btn.classList.remove("border-b-2", "border-brand-400", "text-brand-200");
          btn.classList.add("border-transparent", "text-slate-400");
        }
      });

      const { overviewEl, participantsEl, matchesEl, standingsEl, bracketEl } = panels;
      const map = { overview: overviewEl, participants: participantsEl, matches: matchesEl, standings: standingsEl, bracket: bracketEl };
      Object.entries(map).forEach(([key, el]) => {
        if (!el) return;
        if (key === active) el.classList.remove("hidden");
        else el.classList.add("hidden");
      });
    }

    function renderOverviewTab(container, t, viewLink, joinLink) {
      container.innerHTML = `
        <div class="space-y-3 text-[11px] sm:text-xs">
          <div class="bg-slate-950 border border-slate-800 rounded-2xl px-3 py-2.5">
            <div class="font-semibold text-slate-200 mb-1 flex items-center gap-1.5">
              <span class="inline-flex h-1.5 w-1.5 rounded-full bg-brand-400"></span>
              Share Links
            </div>
            <div class="space-y-1.5">
              <div class="flex flex-col sm:flex-row sm:items-center gap-1">
                <span class="text-slate-400 w-28 shrink-0">Public View:</span>
                <span class="break-all text-slate-100">${viewLink}</span>
              </div>
              <div class="flex flex-col sm:flex-row sm:items-center gap-1">
                <span class="text-slate-400 w-28 shrink-0">Player Join:</span>
                <span class="break-all text-slate-100">${joinLink}</span>
              </div>
            </div>
          </div>

          <div class="bg-slate-950 border border-slate-800 rounded-2xl px-3 py-2.5">
            <div class="font-semibold text-slate-200 mb-1">Settings</div>
            <ul class="text-slate-400 list-disc ml-4 space-y-1">
              <li>Platform: <span class="text-slate-100">${t.platform}</span></li>
              <li>Mode: <span class="text-slate-100">${t.mode}</span></li>
              <li>Type: <span class="text-slate-100">${t.type}</span></li>
              ${t.startDate ? `<li>Start date: <span class="text-slate-100">${t.startDate}</span></li>` : ""}
              ${t.maxParticipants ? `<li>Max participants: <span class="text-slate-100">${t.maxParticipants}</span></li>` : ""}
            </ul>
            ${t.notes ? `
              <div class="mt-2">
                <div class="text-slate-300 font-medium mb-1">Notes</div>
                <p class="text-slate-400">${t.notes}</p>
              </div>
            ` : ""}
          </div>
        </div>
      `;
    }

    function renderParticipantsTab(container, t, players, teams) {
      const playerRows = players.map((p, idx) => `
        <tr class="border-b border-slate-800">
          <td class="px-2 py-1 text-[11px] text-slate-500">${idx + 1}</td>
          <td class="px-2 py-1 text-xs sm:text-sm text-slate-100">${p.gameName || "-"}</td>
          <td class="px-2 py-1 text-[11px] text-slate-300">${p.realName || "-"}</td>
          <td class="px-2 py-1 text-[11px] text-slate-300">${p.gameId || "-"}</td>
          <td class="px-2 py-1 text-[11px] text-slate-300">${p.mobile || "-"}</td>
        </tr>
      `).join("");

      const teamRows = teams.map((tm, idx) => {
        const membersLines = (tm.members || []).map(m => {
          return `<div class="text-[11px] text-slate-200">
            ${m.gameName || "-"}
            <span class="text-slate-500">(${m.realName || "Unknown"}, ${m.gameId || "No ID"}, ${m.mobile || "No mobile"})</span>
          </div>`;
        }).join("");

        return `
          <tr class="border-b border-slate-800 align-top">
            <td class="px-2 py-1 text-[11px] text-slate-500">${idx + 1}</td>
            <td class="px-2 py-1 text-xs sm:text-sm text-slate-100">${tm.name}</td>
            <td class="px-2 py-1">${membersLines || '<span class="text-[11px] text-slate-500">No members yet</span>'}</td>
            <td class="px-2 py-1 text-[11px] text-slate-300">${tm.teamCode || "-"}</td>
          </tr>
        `;
      }).join("");

      container.innerHTML = `
        <div class="grid md:grid-cols-2 gap-4">
          <div class="space-y-2">
            <h4 class="font-semibold text-slate-100 text-xs sm:text-sm">Players (1v1)</h4>
            <div class="overflow-x-auto rounded-2xl border border-slate-800 bg-slate-950/90">
              <table class="min-w-full text-[11px] sm:text-xs">
                <thead class="bg-slate-900 text-slate-300">
                  <tr>
                    <th class="px-2 py-1 text-left w-6">#</th>
                    <th class="px-2 py-1 text-left">Game Name</th>
                    <th class="px-2 py-1 text-left">Real Name</th>
                    <th class="px-2 py-1 text-left">Game ID</th>
                    <th class="px-2 py-1 text-left">Mobile</th>
                  </tr>
                </thead>
                <tbody>
                  ${playerRows || `
                    <tr>
                      <td colspan="5" class="px-2 py-3 text-[11px] text-slate-500 text-center">
                        No players yet (used only in 1v1 tournaments).
                      </td>
                    </tr>
                  `}
                </tbody>
              </table>
            </div>
          </div>

          <div class="space-y-2">
            <h4 class="font-semibold text-slate-100 text-xs sm:text-sm">Teams (2v2 / 3v3)</h4>
            <div class="overflow-x-auto rounded-2xl border border-slate-800 bg-slate-950/90">
              <table class="min-w-full text-[11px] sm:text-xs">
                <thead class="bg-slate-900 text-slate-300">
                  <tr>
                    <th class="px-2 py-1 text-left w-6">#</th>
                    <th class="px-2 py-1 text-left">Team</th>
                    <th class="px-2 py-1 text-left">Members (Game Name · Real Name · Game ID · Mobile)</th>
                    <th class="px-2 py-1 text-left">Team Code</th>
                  </tr>
                </thead>
                <tbody>
                  ${teamRows || `
                    <tr>
                      <td colspan="4" class="px-2 py-3 text-[11px] text-slate-500 text-center">
                        No teams yet (used in 2v2 / 3v3).
                      </td>
                    </tr>
                  `}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    async function renderMatchesTab(container, t, players, teams) {
      const docRef = doc(db, "tournaments", t.id);
      const matchesSnap = await getDocs(
        query(collection(docRef, "matches"), orderBy("round", "asc"))
      );
      const matches = [];
      matchesSnap.forEach(m => matches.push({ id: m.id, ...m.data() }));

      const isTeams = t.mode !== "1v1";
      const entities = isTeams
        ? teams.map(tm => ({ id: tm.id, displayName: tm.name }))
        : players.map(p => ({ id: p.id, displayName: p.gameName || "Player" }));

      container.innerHTML = `
        <div class="space-y-3 text-[11px] sm:text-xs">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
            <div>
              <h4 class="font-semibold text-slate-100 text-sm">Match Center</h4>
              <p class="text-slate-400">
                Generate fixtures and input scores. Standings update automatically.
              </p>
            </div>
            <div class="flex flex-wrap gap-2">
              <button id="btnGenerateFixtures"
                class="px-3 py-1.5 rounded-full bg-brand-400 hover:bg-brand-300 text-slate-950 font-semibold shadow-brand-glow btn-glow">
                Generate Simple Fixtures
              </button>
            </div>
          </div>

          <div id="matchesTableWrapper" class="overflow-x-auto rounded-2xl border border-slate-800 bg-slate-950/90"></div>
        </div>
      `;

      const btnGenerate = document.getElementById("btnGenerateFixtures");
      const tableWrapper = document.getElementById("matchesTableWrapper");

      async function saveFixtures(newMatches) {
        for (const m of newMatches) {
          await addDoc(collection(docRef, "matches"), {
            ...m,
            createdAt: serverTimestamp()
          });
        }
      }

      async function handleGenerate() {
        if (!entities || entities.length < 2) {
          alert("At least 2 participants are required to generate fixtures.");
          return;
        }
        if (matches.length > 0) {
          const confirmReplace = confirm("Matches already exist. Generate more fixtures anyway?");
          if (!confirmReplace) return;
        }

        showLoader();
        try {
          const simpleMatches = createSimpleFixtures(t, entities);
          await saveFixtures(simpleMatches);
          await renderMatchesTab(container, t, players, teams);
        } finally {
          hideLoader();
        }
      }

      btnGenerate.addEventListener("click", handleGenerate);
      renderMatchesTable(tableWrapper, matches, t);
    }

    function createSimpleFixtures(t, entities) {
      const isTeams = t.mode !== "1v1";
      const list = entities;
      const matches = [];
      let round = 1;
      let matchNum = 1;

      if (t.type === "knockout") {
        for (let i = 0; i < list.length; i += 2) {
          if (i + 1 >= list.length) break;
          const home = list[i];
          const away = list[i + 1];
          matches.push({
            type: "knockout",
            round,
            matchNumber: matchNum++,
            entityType: isTeams ? "team" : "player",
            homeId: home.id,
            homeName: home.displayName,
            awayId: away.id,
            awayName: away.displayName,
            homeScore: null,
            awayScore: null,
            status: "pending"
          });
        }
      } else {
        for (let i = 0; i < list.length; i++) {
          for (let j = i + 1; j < list.length; j++) {
            const home = list[i];
            const away = list[j];
            matches.push({
              type: t.type || "league",
              round,
              matchNumber: matchNum++,
              entityType: isTeams ? "team" : "player",
              homeId: home.id,
              homeName: home.displayName,
              awayId: away.id,
              awayName: away.displayName,
              homeScore: null,
              awayScore: null,
              status: "pending"
            });
          }
        }
      }
      return matches;
    }

    function renderMatchesTable(wrapper, matches, t) {
      if (!matches || matches.length === 0) {
        wrapper.innerHTML = `
          <div class="px-3 py-3 text-[11px] text-slate-500 text-center">
            No matches generated yet. Click <span class="text-brand-300">Generate Simple Fixtures</span> to create them.
          </div>
        `;
        return;
      }

      const rows = matches.map((m, idx) => `
        <tr class="border-b border-slate-800">
          <td class="px-2 py-1 text-[11px] text-slate-500">${idx + 1}</td>
          <td class="px-2 py-1 text-[11px] text-slate-400">${m.round || "-"}</td>
          <td class="px-2 py-1 text-[11px] sm:text-xs text-slate-200">
            ${m.homeName} <span class="text-slate-500">vs</span> ${m.awayName}
          </td>
          <td class="px-2 py-1">
            <div class="flex items-center gap-1 text-[11px]">
              <input type="number" min="0" step="1"
                data-mid="${m.id}" data-side="home"
                value="${m.homeScore ?? ""}"
                class="w-12 rounded bg-slate-900 border border-slate-700 px-1 py-0.5 text-center" />
              <span>-</span>
              <input type="number" min="0" step="1"
                data-mid="${m.id}" data-side="away"
                value="${m.awayScore ?? ""}"
                class="w-12 rounded bg-slate-900 border border-slate-700 px-1 py-0.5 text-center" />
            </div>
          </td>
          <td class="px-2 py-1 text-[11px] text-slate-400">
            ${m.status || "pending"}
          </td>
          <td class="px-2 py-1">
            <button data-mid="${m.id}"
              class="btn-save-match px-2 py-1 rounded-full bg-brand-400 hover:bg-brand-300 text-[11px] text-slate-950 font-semibold btn-glow">
              Save
            </button>
          </td>
        </tr>
      `).join("");

      wrapper.innerHTML = `
        <table class="min-w-full text-[11px] sm:text-xs">
          <thead class="bg-slate-900 text-slate-300">
            <tr>
              <th class="px-2 py-1 text-left w-6">#</th>
              <th class="px-2 py-1 text-left w-10">Rd</th>
              <th class="px-2 py-1 text-left">Match</th>
              <th class="px-2 py-1 text-left w-28">Score</th>
              <th class="px-2 py-1 text-left w-20">Status</th>
              <th class="px-2 py-1 text-left w-16">Action</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;

      const docRef = doc(db, "tournaments", t.id);
      const saveButtons = wrapper.querySelectorAll(".btn-save-match");

      saveButtons.forEach(btn => {
        btn.addEventListener("click", async () => {
          const mid = btn.getAttribute("data-mid");
          const homeInput = wrapper.querySelector(`input[data-mid="${mid}"][data-side="home"]`);
          const awayInput = wrapper.querySelector(`input[data-mid="${mid}"][data-side="away"]`);

          const homeScore = homeInput.value === "" ? null : Number(homeInput.value);
          const awayScore = awayInput.value === "" ? null : Number(awayInput.value);

          showLoader();
          try {
            await updateDoc(doc(docRef, "matches", mid), {
              homeScore,
              awayScore,
              status: (homeScore !== null && awayScore !== null) ? "completed" : "pending"
            });
            btn.textContent = "Saved";
            setTimeout(() => { btn.textContent = "Save"; }, 900);
          } finally {
            hideLoader();
          }
        });
      });
    }

    async function renderStandingsTab(container, t) {
      const docRef = doc(db, "tournaments", t.id);

      if (t.type !== "league" && t.type !== "groups_knockout") {
        container.innerHTML = `
          <p class="text-[11px] text-slate-400">
            Standings are calculated for <span class="text-slate-100">League</span> or <span class="text-slate-100">Groups + Knockout</span> tournaments.
          </p>
        `;
        return;
      }

      const isTeams = t.mode !== "1v1";

      const entities = [];
      if (isTeams) {
        const tmSnap = await getDocs(collection(docRef, "teams"));
        tmSnap.forEach(tm => entities.push({ id: tm.id, name: tm.data().name || "Team" }));
      } else {
        const pSnap = await getDocs(collection(docRef, "players"));
        pSnap.forEach(p => entities.push({ id: p.id, name: p.data().gameName || "Player" }));
      }

      if (entities.length === 0) {
        container.innerHTML = `
          <p class="text-[11px] text-slate-400">
            No participants yet. Standings appear after matches are played.
          </p>
        `;
        return;
      }

      const mSnap = await getDocs(collection(docRef, "matches"));
      const matches = [];
      mSnap.forEach(m => matches.push({ id: m.id, ...m.data() }));

      const table = {};
      entities.forEach(e => {
        table[e.id] = {
          id: e.id,
          name: e.name,
          played: 0,
          won: 0,
          drawn: 0,
          lost: 0,
          gf: 0,
          ga: 0,
          pts: 0
        };
      });

      matches.forEach(m => {
        if (m.status !== "completed") return;
        if (m.homeScore == null || m.awayScore == null) return;

        const home = table[m.homeId];
        const away = table[m.awayId];
        if (!home || !away) return;

        home.played++;
        away.played++;
        home.gf += m.homeScore;
        home.ga += m.awayScore;
        away.gf += m.awayScore;
        away.ga += m.homeScore;

        if (m.homeScore > m.awayScore) {
          home.won++; away.lost++; home.pts += 3;
        } else if (m.homeScore < m.awayScore) {
          away.won++; home.lost++; away.pts += 3;
        } else {
          home.drawn++; away.drawn++; home.pts += 1; away.pts += 1;
        }
      });

      const rowsArr = Object.values(table).map(r => ({ ...r, gd: r.gf - r.ga }));
      rowsArr.sort((a, b) => {
        if (b.pts !== a.pts) return b.pts - a.pts;
        if (b.gd !== a.gd) return b.gd - a.gd;
        return b.gf - a.gf;
      });

      const rowsHtml = rowsArr.map((r, idx) => `
        <tr class="border-b border-slate-800">
          <td class="px-2 py-1 text-[11px] text-slate-500">${idx + 1}</td>
          <td class="px-2 py-1 text-xs sm:text-sm text-slate-100">${r.name}</td>
          <td class="px-2 py-1 text-[11px] text-slate-300 text-center">${r.played}</td>
          <td class="px-2 py-1 text-[11px] text-slate-300 text-center">${r.won}</td>
          <td class="px-2 py-1 text-[11px] text-slate-300 text-center">${r.drawn}</td>
          <td class="px-2 py-1 text-[11px] text-slate-300 text-center">${r.lost}</td>
          <td class="px-2 py-1 text-[11px] text-slate-300 text-center">${r.gf}</td>
          <td class="px-2 py-1 text-[11px] text-slate-300 text-center">${r.ga}</td>
          <td class="px-2 py-1 text-[11px] text-slate-300 text-center">${r.gf - r.ga}</td>
          <td class="px-2 py-1 text-[11px] text-brand-200 font-semibold text-center">${r.pts}</td>
        </tr>
      `).join("");

      container.innerHTML = `
        <div class="space-y-2">
          <div class="flex items-center justify-between">
            <h4 class="font-semibold text-slate-100 text-xs sm:text-sm">League Standings</h4>
            <p class="text-[10px] text-slate-400">
              System: Win = 3 pts, Draw = 1 pt, Loss = 0 pts
            </p>
          </div>
          <div class="overflow-x-auto rounded-2xl border border-slate-800 bg-slate-950/90">
            <table class="min-w-full text-[11px] sm:text-xs">
              <thead class="bg-slate-900 text-slate-300">
                <tr>
                  <th class="px-2 py-1 text-left w-6">#</th>
                  <th class="px-2 py-1 text-left">Name</th>
                  <th class="px-2 py-1 text-center w-8">P</th>
                  <th class="px-2 py-1 text-center w-8">W</th>
                  <th class="px-2 py-1 text-center w-8">D</th>
                  <th class="px-2 py-1 text-center w-8">L</th>
                  <th class="px-2 py-1 text-center w-8">GF</th>
                  <th class="px-2 py-1 text-center w-8">GA</th>
                  <th class="px-2 py-1 text-center w-8">GD</th>
                  <th class="px-2 py-1 text-center w-10">Pts</th>
                </tr>
              </thead>
              <tbody>
                ${rowsHtml || `
                  <tr>
                    <td colspan="10" class="px-2 py-3 text-[11px] text-slate-500 text-center">
                      No completed matches yet. Standings will update as results are saved.
                    </td>
                  </tr>
                `}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    function renderBracketTab(container, t) {
      container.innerHTML = `
        <div class="text-[11px] sm:text-xs text-slate-400 space-y-2">
          <p>Knockout bracket visual can be added later on top of your saved matches.</p>
          <p>You already have fixtures, scores and standings working as a base system.</p>
        </div>
      `;
    }

    // Tournament detail
    async function renderTournamentDetail() {
      if (!selectedTournamentId) {
        tournamentDetailEl.innerHTML =
          "<p class='text-xs text-slate-400'>Select a tournament.</p>";
        return;
      }

      showLoader();
      try {
        const docRef = doc(db, "tournaments", selectedTournamentId);
        const snap = await getDoc(docRef);
        if (!snap.exists()) {
          tournamentDetailEl.innerHTML =
            "<p class='text-xs text-red-300'>Tournament not found.</p>";
          return;
        }

        const t = { id: snap.id, ...snap.data() };

        let players = [];
        let teams = [];
        if (t.mode === "1v1") {
          const pSnap = await getDocs(collection(docRef, "players"));
          pSnap.forEach(p => players.push({ id: p.id, ...p.data() }));
        } else {
          const tmSnap = await getDocs(collection(docRef, "teams"));
          tmSnap.forEach(tm => teams.push({ id: tm.id, ...tm.data() }));
        }

        const participantsLabel = t.mode === "1v1" ? "Players" : "Teams";

        const baseUrl = window.location.origin + window.location.pathname;
        const viewLink = `${baseUrl}?view=${t.id}`;
        const joinLink = `${baseUrl}?join=${t.id}`;

        const typeLabel =
          t.type === "league" ? "League" :
          t.type === "knockout" ? "Knockout" :
          t.type === "groups_knockout" ? "Groups + Knockout" :
          t.type;

        tournamentDetailEl.innerHTML = `
          <div class="flex flex-col gap-4">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
              <div class="min-w-0">
                <h3 class="text-lg sm:text-xl font-semibold text-slate-50 truncate flex items-center gap-2">
                  <span class="inline-flex h-6 w-6 rounded-full border border-brand-400/60 bg-brand-400/10 items-center justify-center text-[11px] text-brand-200">T</span>
                  <span class="truncate">${t.name}</span>
                </h3>
                <p class="text-[11px] text-slate-400 mt-1 flex flex-wrap gap-x-2 gap-y-0.5">
                  <span>${t.platform}</span>
                  <span>• ${t.mode}</span>
                  <span>• ${typeLabel}</span>
                  ${t.startDate ? `<span>• Starts ${t.startDate}</span>` : ""}
                </p>
              </div>
              <div class="text-[11px] text-slate-400">
                ${participantsLabel}: <span class="font-semibold text-slate-100">
                  ${t.mode === "1v1" ? players.length : teams.length}
                </span>
              </div>
            </div>

            <div class="border-b border-slate-800 flex flex-wrap gap-2 text-[11px] sm:text-xs">
              <button data-tab="overview"
                class="t-tab-btn px-3 py-1.5 rounded-t-lg border-b-2 border-brand-400 text-brand-200 bg-slate-950">
                Overview
              </button>
              <button data-tab="participants"
                class="t-tab-btn px-3 py-1.5 rounded-t-lg border-b-2 border-transparent text-slate-400 hover:text-slate-200">
                Players & Teams
              </button>
              <button data-tab="matches"
                class="t-tab-btn px-3 py-1.5 rounded-t-lg border-b-2 border-transparent text-slate-400 hover:text-slate-200">
                Match Center
              </button>
              <button data-tab="standings"
                class="t-tab-btn px-3 py-1.5 rounded-t-lg border-b-2 border-transparent text-slate-400 hover:text-slate-200">
                Standings
              </button>
              <button data-tab="bracket"
                class="t-tab-btn px-3 py-1.5 rounded-t-lg border-b-2 border-transparent text-slate-400 hover:text-slate-200">
                Bracket
              </button>
            </div>

            <div class="mt-3 space-y-4">
              <div id="tab-overview" class="t-tab-panel"></div>
              <div id="tab-participants" class="t-tab-panel hidden"></div>
              <div id="tab-matches" class="t-tab-panel hidden"></div>
              <div id="tab-standings" class="t-tab-panel hidden"></div>
              <div id="tab-bracket" class="t-tab-panel hidden"></div>
            </div>
          </div>
        `;

        const tabButtons = tournamentDetailEl.querySelectorAll(".t-tab-btn");
        const overviewEl = document.getElementById("tab-overview");
        const participantsEl = document.getElementById("tab-participants");
        const matchesEl = document.getElementById("tab-matches");
        const standingsEl = document.getElementById("tab-standings");
        const bracketEl = document.getElementById("tab-bracket");

        renderOverviewTab(overviewEl, t, viewLink, joinLink);
        renderParticipantsTab(participantsEl, t, players, teams);
        await renderMatchesTab(matchesEl, t, players, teams);
        await renderStandingsTab(standingsEl, t);
        renderBracketTab(bracketEl, t);

        tabButtons.forEach(btn => {
          btn.addEventListener("click", () => {
            const tab = btn.getAttribute("data-tab");
            setActiveTab(tabButtons, tab, {
              overviewEl,
              participantsEl,
              matchesEl,
              standingsEl,
              bracketEl
            });
          });
        });
      } finally {
        hideLoader();
      }
    }

    // Create tournament submit
    createTournamentForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser) return;

      const name = document.getElementById("tName").value.trim();
      const platform = document.getElementById("tPlatform").value;
      const modeVal = document.getElementById("tMode").value;
      const typeVal = document.getElementById("tType").value;
      const startDate = document.getElementById("tStart").value;
      const maxParticipants = Number(document.getElementById("tMaxPlayers").value) || null;
      const notes = document.getElementById("tNotes").value.trim();

      if (!name) {
        alert("Please enter a tournament name.");
        return;
      }

      showLoader();
      try {
        const docRef = await addDoc(collection(db, "tournaments"), {
          name,
          platform,
          mode: modeVal,
          type: typeVal,
          startDate: startDate || null,
          maxParticipants,
          notes,
          ownerUid: currentUser.uid,
          createdAt: serverTimestamp(),
          playerCount: 0,
          teamCount: 0
        });

        await loadTournamentsForUser(currentUser.uid);
        selectedTournamentId = docRef.id;
        await renderTournamentDetail();

        e.target.reset();
        document.getElementById("tMaxPlayers").value = 16;
      } finally {
        hideLoader();
      }
    });

    // Public helpers
    function generateTeamCode() {
      const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
      let code = "";
      for (let i = 0; i < 4; i++) {
        code += chars[Math.floor(Math.random() * chars.length)];
      }
      return code;
    }

    async function loadPublicTournament(tId, modeType) {
      showLoader();
      try {
        const docRef = doc(db, "tournaments", tId);
        const snap = await getDoc(docRef);
        if (!snap.exists()) {
          publicTournamentInfo.textContent = "Tournament not found.";
          return;
        }
        const t = { id: snap.id, ...snap.data() };

        const typeLabel =
          t.type === "league" ? "League" :
          t.type === "knockout" ? "Knockout" :
          t.type === "groups_knockout" ? "Groups + Knockout" :
          t.type;

        publicTournamentInfo.innerHTML = `
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
            <div>
              <h2 class="text-lg sm:text-xl font-semibold text-slate-50 mb-0.5 flex items-center gap-2">
                <span class="inline-flex h-6 w-6 rounded-full bg-brand-400/10 border border-brand-400/60 items-center justify-center text-[11px] text-brand-200">T</span>
                <span>${t.name}</span>
              </h2>
              <p class="text-[11px] text-slate-400 flex flex-wrap gap-x-2 gap-y-0.5">
                <span>${t.platform}</span>
                <span>• ${t.mode}</span>
                <span>• ${typeLabel}</span>
                ${t.startDate ? `<span>• Starts ${t.startDate}</span>` : ""}
              </p>
              ${t.notes ? `<p class="text-[11px] text-slate-300 mt-1">${t.notes}</p>` : ""}
            </div>
            <div class="text-[11px] text-slate-400">
              Mode: <span class="text-brand-300 font-medium">${modeType === "view" ? "Viewer" : "Join"}</span>
            </div>
          </div>
        `;

        if (modeType === "view") {
          await renderPublicView(t);
        } else if (modeType === "join") {
          await renderPublicJoin(t);
        }
      } finally {
        hideLoader();
      }
    }

    async function renderPublicView(t) {
      const docRef = doc(db, "tournaments", t.id);
      let players = [];
      let teams = [];
      if (t.mode === "1v1") {
        const pSnap = await getDocs(collection(docRef, "players"));
        pSnap.forEach(p => players.push({ id: p.id, ...p.data() }));
      } else {
        const tmSnap = await getDocs(collection(docRef, "teams"));
        tmSnap.forEach(tm => teams.push({ id: tm.id, ...tm.data() }));
      }

      const playerRows = players.map((p, idx) => `
        <tr class="border-b border-slate-800">
          <td class="px-2 py-1 text-[11px] text-slate-500">${idx + 1}</td>
          <td class="px-2 py-1 text-xs sm:text-sm">${p.gameName || "-"}</td>
        </tr>
      `).join("");

      const teamRows = teams.map((tm, idx) => {
        const membersNames = (tm.members || []).map(m => m.gameName || "-").join(", ");
        return `
          <tr class="border-b border-slate-800">
            <td class="px-2 py-1 text-[11px] text-slate-500">${idx + 1}</td>
            <td class="px-2 py-1 text-xs sm:text-sm">${tm.name}</td>
            <td class="px-2 py-1 text-[11px] text-slate-400">${membersNames || "-"}</td>
          </tr>
        `;
      }).join("");

      publicModeContent.innerHTML = `
        <div class="grid md:grid-cols-2 gap-4">
          <div class="space-y-2">
            <h3 class="font-semibold text-slate-100 text-xs sm:text-sm">Players</h3>
            <div class="overflow-x-auto rounded-2xl border border-slate-800 bg-slate-950/90">
              <table class="min-w-full text-[11px] sm:text-xs">
                <thead class="bg-slate-900 text-slate-300">
                  <tr>
                    <th class="px-2 py-1 text-left w-6">#</th>
                    <th class="px-2 py-1 text-left">Game Name</th>
                  </tr>
                </thead>
                <tbody>
                  ${playerRows || `
                    <tr>
                      <td colspan="2" class="px-2 py-3 text-[11px] text-slate-500 text-center">
                        No players registered yet.
                      </td>
                    </tr>
                  `}
                </tbody>
              </table>
            </div>
          </div>
          <div class="space-y-2">
            <h3 class="font-semibold text-slate-100 text-xs sm:text-sm">Teams</h3>
            <div class="overflow-x-auto rounded-2xl border border-slate-800 bg-slate-950/90">
              <table class="min-w-full text-[11px] sm:text-xs">
                <thead class="bg-slate-900 text-slate-300">
                  <tr>
                    <th class="px-2 py-1 text-left w-6">#</th>
                    <th class="px-2 py-1 text-left">Team</th>
                    <th class="px-2 py-1 text-left">Members (Game Name)</th>
                  </tr>
                </thead>
                <tbody>
                  ${teamRows || `
                    <tr>
                      <td colspan="3" class="px-2 py-3 text-[11px] text-slate-500 text-center">
                        No teams registered yet.
                      </td>
                    </tr>
                  `}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    async function renderPublicJoin(t) {
      const docRef = doc(db, "tournaments", t.id);

      let currentCount = 0;
      if (t.mode === "1v1") {
        const pSnap = await getDocs(collection(docRef, "players"));
        pSnap.forEach(() => currentCount++);
      } else {
        const tmSnap = await getDocs(collection(docRef, "teams"));
        tmSnap.forEach(() => currentCount++);
      }
      const max = t.maxParticipants || 0;
      const slotsLeft = max ? (max - currentCount) : null;

      let statusText = "";
      if (max) {
        statusText = slotsLeft > 0
          ? `<span class="text-emerald-300 font-semibold">${slotsLeft}</span> spots remaining (of ${max}).`
          : `<span class="text-red-300 font-semibold">No spots remaining.</span>`;
      } else {
        statusText = "Open registration (no limit set by organiser).";
      }

      let joinContent = "";

      if (t.mode === "1v1") {
        joinContent = `
          <div class="space-y-3">
            <div>
              <h3 class="font-semibold text-slate-100 text-sm">Join as Player (1v1)</h3>
              <p class="text-[11px] text-slate-400 mt-1">${statusText}</p>
            </div>
            <form id="joinPlayerForm" class="space-y-2 text-[11px] sm:text-xs">
              <div>
                <label class="block text-slate-300 mb-1">Real Name</label>
                <input id="joinRealName" type="text" required
                       class="w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-brand-400" />
              </div>
              <div>
                <label class="block text-slate-300 mb-1">Game Name (shown in tournament)</label>
                <input id="joinGameName" type="text" required
                       class="w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-brand-400" />
              </div>
              <div>
                <label class="block text-slate-300 mb-1">Game ID</label>
                <input id="joinGameId" type="text" required
                       class="w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-brand-400" />
              </div>
              <div>
                <label class="block text-slate-300 mb-1">Mobile Number</label>
                <input id="joinMobile" type="tel" required
                       class="w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-brand-400" />
              </div>
              <p id="joinPlayerMsg" class="text-[11px] text-emerald-300 min-h-[1.25rem]"></p>
              <button type="submit"
                      class="w-full rounded-xl bg-brand-400 hover:bg-brand-300 text-slate-950 font-semibold py-2 text-xs sm:text-sm shadow-brand-glow btn-glow">
                Book My Spot
              </button>
            </form>
          </div>
        `;
      } else {
        const teamSize = t.mode === "2v2" ? 2 : 3;
        joinContent = `
          <div class="space-y-4">
            <div>
              <h3 class="font-semibold text-slate-100 text-sm">Team Registration (${t.mode})</h3>
              <p class="text-[11px] text-slate-400 mt-1">${statusText}</p>
            </div>
            <div class="grid md:grid-cols-2 gap-4">
              <!-- Create team -->
              <div class="space-y-2">
                <h4 class="font-semibold text-slate-100 text-xs">Create Team (Captain)</h4>
                <form id="createTeamForm" class="space-y-2 text-[11px] sm:text-xs">
                  <div>
                    <label class="block text-slate-300 mb-1">Team Name</label>
                    <input id="teamNameJoin" type="text" required
                           class="w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-brand-400" />
                  </div>
                  <div>
                    <label class="block text-slate-300 mb-1">Captain Real Name</label>
                    <input id="teamCaptainRealNameJoin" type="text" required
                           class="w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-brand-400" />
                  </div>
                  <div>
                    <label class="block text-slate-300 mb-1">Captain Game Name (shown in tournament)</label>
                    <input id="teamCaptainGameNameJoin" type="text" required
                           class="w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-brand-400" />
                  </div>
                  <div>
                    <label class="block text-slate-300 mb-1">Captain Game ID</label>
                    <input id="teamCaptainGameIdJoin" type="text" required
                           class="w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-brand-400" />
                  </div>
                  <div>
                    <label class="block text-slate-300 mb-1">Captain Mobile Number</label>
                    <input id="teamCaptainMobileJoin" type="tel" required
                           class="w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-brand-400" />
                  </div>
                  <p class="text-[10px] text-slate-400">
                    A Team Code will be generated. Share it with teammates so they can join using their own details.
                  </p>
                  <p id="createTeamMsg" class="text-[11px] text-emerald-300 min-h-[1.25rem]"></p>
                  <button type="submit"
                          class="w-full rounded-xl bg-brand-400 hover:bg-brand-300 text-slate-950 font-semibold py-2 text-xs sm:text-sm shadow-brand-glow btn-glow">
                    Create Team
                  </button>
                </form>
              </div>

              <!-- Join existing team -->
              <div class="space-y-2">
                <h4 class="font-semibold text-slate-100 text-xs">Join Existing Team</h4>
                <form id="joinTeamForm" class="space-y-2 text-[11px] sm:text-xs">
                  <div>
                    <label class="block text-slate-300 mb-1">Real Name</label>
                    <input id="joinTeamRealName" type="text" required
                           class="w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-brand-400" />
                  </div>
                  <div>
                    <label class="block text-slate-300 mb-1">Game Name (shown in tournament)</label>
                    <input id="joinTeamGameName" type="text" required
                           class="w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-brand-400" />
                  </div>
                  <div>
                    <label class="block text-slate-300 mb-1">Game ID</label>
                    <input id="joinTeamGameId" type="text" required
                           class="w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-brand-400" />
                  </div>
                  <div>
                    <label class="block text-slate-300 mb-1">Mobile Number</label>
                    <input id="joinTeamMobile" type="tel" required
                           class="w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-brand-400" />
                  </div>
                  <div>
                    <label class="block text-slate-300 mb-1">Team Code</label>
                    <input id="joinTeamCode" type="text" required
                           class="w-full rounded-xl bg-slate-950 border border-slate-800 px-3 py-2 uppercase focus:outline-none focus:ring-1 focus:ring-brand-400" />
                  </div>
                  <p id="joinTeamMsg" class="text-[11px] text-emerald-300 min-h-[1.25rem]"></p>
                  <button type="submit"
                          class="w-full rounded-xl bg-brand-400 hover:bg-brand-300 text-slate-950 font-semibold py-2 text-xs sm:text-sm shadow-brand-glow btn-glow">
                    Join Team
                  </button>
                </form>
              </div>
            </div>
          </div>
        `;
      }

      publicModeContent.innerHTML = joinContent;

      if (t.mode === "1v1") {
        const joinForm = document.getElementById("joinPlayerForm");
        const realNameInput = document.getElementById("joinRealName");
        const gameNameInput = document.getElementById("joinGameName");
        const gameIdInput = document.getElementById("joinGameId");
        const mobileInput = document.getElementById("joinMobile");
        const msg = document.getElementById("joinPlayerMsg");

        joinForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          msg.textContent = "";
          if (max && slotsLeft <= 0) {
            msg.textContent = "No spots remaining.";
            return;
          }

          const realName = realNameInput.value.trim();
          const gameName = gameNameInput.value.trim();
          const gameId = gameIdInput.value.trim();
          const mobile = mobileInput.value.trim();
          if (!realName || !gameName || !gameId || !mobile) {
            msg.textContent = "Please fill all fields.";
            return;
          }

          showLoader();
          try {
            await addDoc(collection(docRef, "players"), {
              realName,
              gameName,
              gameId,
              mobile,
              createdAt: serverTimestamp()
            });

            await updateDoc(docRef, {
              playerCount: (t.playerCount || 0) + 1
            });

            msg.textContent = "Spot booked successfully!";
            realNameInput.value = "";
            gameNameInput.value = "";
            gameIdInput.value = "";
            mobileInput.value = "";
          } finally {
            hideLoader();
          }
        });
      } else {
        const teamSize = t.mode === "2v2" ? 2 : 3;

        const createTeamForm = document.getElementById("createTeamForm");
        const createTeamMsg = document.getElementById("createTeamMsg");
        const teamNameJoin = document.getElementById("teamNameJoin");
        const teamCaptainRealNameJoin = document.getElementById("teamCaptainRealNameJoin");
        const teamCaptainGameNameJoin = document.getElementById("teamCaptainGameNameJoin");
        const teamCaptainGameIdJoin = document.getElementById("teamCaptainGameIdJoin");
        const teamCaptainMobileJoin = document.getElementById("teamCaptainMobileJoin");

        createTeamForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          createTeamMsg.textContent = "";

          if (max && slotsLeft <= 0) {
            createTeamMsg.textContent = "No team slots remaining.";
            return;
          }

          const teamName = teamNameJoin.value.trim();
          const capReal = teamCaptainRealNameJoin.value.trim();
          const capGameName = teamCaptainGameNameJoin.value.trim();
          const capGameId = teamCaptainGameIdJoin.value.trim();
          const capMobile = teamCaptainMobileJoin.value.trim();

          if (!teamName || !capReal || !capGameName || !capGameId || !capMobile) {
            createTeamMsg.textContent = "All captain fields are required.";
            return;
          }

          const teamCode = generateTeamCode();

          showLoader();
          try {
            await addDoc(collection(docRef, "teams"), {
              name: teamName,
              members: [{
                realName: capReal,
                gameName: capGameName,
                gameId: capGameId,
                mobile: capMobile
              }],
              teamCode,
              maxSize: teamSize,
              createdAt: serverTimestamp()
            });

            await updateDoc(docRef, {
              teamCount: (t.teamCount || 0) + 1
            });

            createTeamMsg.textContent =
              `Team created! Share this Team Code with your teammates: ${teamCode}`;
            teamNameJoin.value = "";
            teamCaptainRealNameJoin.value = "";
            teamCaptainGameNameJoin.value = "";
            teamCaptainGameIdJoin.value = "";
            teamCaptainMobileJoin.value = "";
          } finally {
            hideLoader();
          }
        });

        const joinTeamForm = document.getElementById("joinTeamForm");
        const joinTeamRealName = document.getElementById("joinTeamRealName");
        const joinTeamGameName = document.getElementById("joinTeamGameName");
        const joinTeamGameId = document.getElementById("joinTeamGameId");
        const joinTeamMobile = document.getElementById("joinTeamMobile");
        const joinTeamCode = document.getElementById("joinTeamCode");
        const joinTeamMsg = document.getElementById("joinTeamMsg");

        joinTeamForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          joinTeamMsg.textContent = "";

          const realName = joinTeamRealName.value.trim();
          const gameName = joinTeamGameName.value.trim();
          const gameId = joinTeamGameId.value.trim();
          const mobile = joinTeamMobile.value.trim();
          const codeInput = joinTeamCode.value.trim().toUpperCase();

          if (!realName || !gameName || !gameId || !mobile || !codeInput) {
            joinTeamMsg.textContent = "All fields are required.";
            return;
          }

          showLoader();
          try {
            const tmSnap = await getDocs(
              query(collection(docRef, "teams"), where("teamCode", "==", codeInput))
            );
            if (tmSnap.empty) {
              joinTeamMsg.textContent = "Invalid team code.";
              return;
            }
            const teamDoc = tmSnap.docs[0];
            const teamData = teamDoc.data();
            const members = teamData.members || [];
            const maxSize = teamData.maxSize || teamSize;

            if (members.length >= maxSize) {
              joinTeamMsg.textContent = "Team is already full.";
              return;
            }

            if (members.find(m =>
              m.gameName.toLowerCase() === gameName.toLowerCase() &&
              m.realName.toLowerCase() === realName.toLowerCase()
            )) {
              joinTeamMsg.textContent = "You are already in this team.";
              return;
            }

            members.push({ realName, gameName, gameId, mobile });
            await updateDoc(teamDoc.ref, { members });

            joinTeamMsg.textContent = "You have joined the team successfully!";
            joinTeamRealName.value = "";
            joinTeamGameName.value = "";
            joinTeamGameId.value = "";
            joinTeamMobile.value = "";
            joinTeamCode.value = "";
          } finally {
            hideLoader();
          }
        });
      }
    }

    // Auth state handling
    onAuthStateChanged(auth, async (user) => {
      showLoader();
      try {
        currentUser = user || null;

        if (mode === "organiser") {
          publicSection.classList.add("hidden");

          if (!currentUser) {
            heroSection?.classList.remove("hidden");
            authSection.classList.remove("hidden");
            organiserSection.classList.add("hidden");
            logoutBtn.classList.add("hidden");
          } else {
            heroSection?.classList.add("hidden");
            authSection.classList.add("hidden");
            organiserSection.classList.remove("hidden");
            logoutBtn.classList.remove("hidden");
            await loadTournamentsForUser(currentUser.uid);
          }
        } else {
          heroSection?.classList.add("hidden");
          authSection.classList.add("hidden");
          organiserSection.classList.add("hidden");
          logoutBtn.classList.add("hidden");
          publicSection.classList.remove("hidden");

          if (mode === "view" && viewId) {
            await loadPublicTournament(viewId, "view");
          } else if (mode === "join" && joinId) {
            await loadPublicTournament(joinId, "join");
          } else {
            publicTournamentInfo.textContent = "Invalid or missing tournament id.";
          }
        }
      } finally {
        hideLoader();
      }
    });

    setAuthMode("login");
  </script>
</body>
</html>
