<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Efootball Tournament Platform by PesPagol</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              100: "#E0F2FE",
              200: "#BAE6FD",
              300: "#7DD3FC",
              400: "#22D3EE",
            },
          },
          boxShadow: {
            "brand-glow": "0 0 35px rgba(34,211,238,0.35)",
          },
        },
      },
    };
  </script>

  <!-- jsPDF for fixture export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      min-height: 100vh;
      background:
        radial-gradient(circle at top left, rgba(34,211,238,0.20), transparent 60%),
        radial-gradient(circle at bottom right, rgba(15,23,42,0.90), #020617),
        url("bg_efootball.jpg") center/cover fixed no-repeat;
      color: #e5e7eb;
    }
    .glass-panel {
      backdrop-filter: blur(16px);
      background: linear-gradient(to bottom right, rgba(15,23,42,0.9), rgba(15,23,42,0.85));
    }
    .btn-glow {
      box-shadow: 0 0 20px rgba(34,211,238,0.45);
    }
    .card-hover {
      transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease, background 0.15s ease;
    }
    .card-hover:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 35px rgba(15,23,42,0.9);
      border-color: rgba(148, 163, 184, 0.6);
      background: rgba(15,23,42,0.95);
    }
    .match-updated {
      animation: pulse-row 0.6s ease-out;
    }
    @keyframes pulse-row {
      0% { background-color: rgba(16,185,129,0.15); }
      100% { background-color: transparent; }
    }
  </style>
</head>
<body class="text-slate-100">
  <!-- Global loader -->
  <div id="globalLoader" class="fixed inset-0 flex items-center justify-center bg-slate-950/70 z-40 hidden">
    <div class="flex flex-col items-center gap-2">
      <div class="h-8 w-8 border-2 border-brand-400 border-t-transparent rounded-full animate-spin"></div>
      <p class="text-xs text-slate-300">Syncing with PesPagol cloud…</p>
    </div>
  </div>

  <div class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="w-full border-b border-slate-800/70 bg-slate-950/80 backdrop-blur">
      <div class="max-w-6xl mx-auto px-3 sm:px-4 py-3 flex items-center justify-between gap-3">
        <div class="flex items-center gap-2 sm:gap-3 min-w-0">
          <img src="pespagol_logo.png" alt="PesPagol Logo" class="h-8 w-8 sm:h-10 sm:w-10 rounded-full border border-brand-400/70 bg-slate-900/70 object-cover" />
          <div class="min-w-0">
            <h1 class="text-sm sm:text-base md:text-lg font-semibold text-slate-50 truncate">
              Efootball Tournament Platform by PesPagol
            </h1>
            <p id="headerModeTag" class="text-[10px] sm:text-[11px] text-brand-200/80 truncate hidden"></p>
          </div>
        </div>
        <div class="flex items-center gap-2 sm:gap-3">
          <button id="logoutBtn"
            class="hidden px-3 py-1.5 rounded-full bg-slate-900 border border-slate-700 text-[11px] text-slate-200 hover:bg-slate-800">
            Sign out
          </button>
        </div>
      </div>
    </header>

    <main class="flex-1">
      <div class="max-w-6xl mx-auto px-3 sm:px-4 py-4 sm:py-6 space-y-5 sm:space-y-6">
        <!-- Hero (organiser only) -->
        <section id="heroSection" class="glass-panel rounded-3xl border border-slate-800/80 px-4 sm:px-6 py-4 sm:py-5 shadow-xl">
          <div class="grid md:grid-cols-[3fr,2fr] gap-4 sm:gap-6 items-center">
            <div class="space-y-3 sm:space-y-4">
              <div class="inline-flex items-center gap-1.5 rounded-full bg-brand-400/10 border border-brand-400/40 px-2.5 py-1">
                <span class="h-1.5 w-1.5 rounded-full bg-brand-400 animate-pulse"></span>
                <span class="text-[10px] sm:text-[11px] text-brand-100">Host PES & eFootball events in minutes</span>
              </div>
              <div>
                <h2 class="text-lg sm:text-2xl font-semibold text-slate-50 leading-snug">
                  Create. Share. Manage.<br class="hidden sm:block" />
                  <span class="text-brand-300">All your tournaments in one link.</span>
                </h2>
                <p class="mt-2 text-[11px] sm:text-xs text-slate-300">
                  One page for everything — host 1v1, 2v2, 3v3 tournaments, generate fixtures automatically,
                  and let players book their spots with their game name and ID.
                </p>
              </div>
              <div class="flex flex-wrap items-center gap-2">
                <button id="heroPrimaryBtn"
                  class="px-3 sm:px-4 py-1.5 sm:py-2 rounded-full bg-brand-400 hover:bg-brand-300 text-slate-950 text-xs sm:text-sm font-semibold btn-glow">
                  Start a new tournament
                </button>
                <button id="heroSecondaryBtn"
                  class="px-3 sm:px-4 py-1.5 sm:py-2 rounded-full bg-slate-900 border border-slate-700 text-[11px] sm:text-xs text-slate-200 hover:bg-slate-800">
                  Login / Sign up
                </button>
              </div>
              <div class="flex flex-wrap gap-4 text-[10px] sm:text-[11px] text-slate-400">
                <div class="flex items-center gap-1.5">
                  <span class="h-1.5 w-1.5 rounded-full bg-emerald-400"></span>
                  <span>Auto fixtures & standings</span>
                </div>
                <div class="flex items-center gap-1.5">
                  <span class="h-1.5 w-1.5 rounded-full bg-sky-400"></span>
                  <span>Free & paid tournaments</span>
                </div>
                <div class="flex items-center gap-1.5">
                  <span class="h-1.5 w-1.5 rounded-full bg-fuchsia-400"></span>
                  <span>Players join with one link</span>
                </div>
              </div>
            </div>

            <!-- Redesigned YouTube / stream card -->
            <div class="relative rounded-3xl border border-brand-400/40 bg-gradient-to-br from-slate-950/95 via-slate-900/95 to-slate-950/95 overflow-hidden shadow-xl">
              <!-- Glow background -->
              <div class="pointer-events-none absolute inset-0 bg-[radial-gradient(circle_at_top,rgba(34,211,238,0.25),transparent_55%)] opacity-70"></div>

              <div class="relative flex flex-col h-full">
                <!-- Header row -->
                <div class="px-3 sm:px-4 pt-3 pb-2 flex items-center justify-between gap-2 border-b border-slate-800/80">
                  <div class="flex items-center gap-2 min-w-0">
                    <div class="h-7 w-7 rounded-full bg-slate-900 border border-brand-300/60 flex items-center justify-center text-[10px] font-semibold text-brand-200">
                      PG
                    </div>
                    <div class="min-w-0">
                      <p class="text-[11px] sm:text-xs font-semibold text-slate-100 truncate">
                        PesPagol Live Arena
                      </p>
                      <p class="text-[10px] text-slate-400 truncate">
                        Highlight & livestream showcase
                      </p>
                    </div>
                  </div>
                  <div class="flex flex-col items-end gap-1">
                    <div class="inline-flex items-center gap-1.5 rounded-full bg-red-500/10 border border-red-500/60 px-2 py-0.5">
                      <span class="h-1.5 w-1.5 rounded-full bg-red-400 animate-ping"></span>
                      <span class="h-1.5 w-1.5 rounded-full bg-red-400 -ml-2"></span>
                      <span class="text-[10px] font-semibold text-red-200">LIVE</span>
                    </div>
                    <span class="text-[10px] text-slate-400 hidden sm:inline">
                      Players can watch while joining
                    </span>
                  </div>
                </div>

                <!-- Video frame -->
                <div class="p-3 sm:p-4 pb-2">
                  <div class="relative rounded-2xl border border-slate-800/90 bg-slate-950/90 shadow-inner overflow-hidden">
                    <div class="aspect-video">
                      <iframe
                        class="w-full h-full"
                        src="https://www.youtube.com/embed/IB4g_M753gg?autoplay=0&mute=1&rel=0&modestbranding=1"
                        title="PesPagol Live"
                        frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                        allowfullscreen>
                      </iframe>
                    </div>
                  </div>
                </div>

                <!-- Footer / description + button -->
                <div class="px-3 sm:px-4 pb-3 pt-1 flex flex-col gap-2">
                  <p class="text-[11px] text-slate-300 leading-snug">
                    Pin your tournament livestream or highlight video here. Everyone opening your
                    tournament link can instantly watch this stream.
                  </p>
                  <div class="flex flex-wrap items-center justify-between gap-2">
                    <p class="text-[10px] text-slate-500">
                      Current: <span class="text-slate-300">YouTube: IB4g_M753gg</span>
                    </p>
                    <a
                      href="https://www.youtube.com/live/IB4g_M753gg"
                      target="_blank"
                      rel="noopener noreferrer"
                      class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-slate-900 border border-slate-700 text-[10px] sm:text-[11px] text-slate-200 hover:bg-slate-800"
                    >
                      <span>Watch on YouTube</span>
                      <span class="text-[13px]">↗</span>
                    </a>
                  </div>
                </div>
              </div>
            </div>
            <!-- End redesigned YouTube card -->
          </div>
        </section>

        <!-- Auth + organiser -->
        <section id="authSection" class="glass-panel rounded-3xl border border-slate-800/80 px-4 sm:px-6 py-4 sm:py-5 shadow-lg">
          <div class="grid md:grid-cols-[2fr,3fr] gap-4 sm:gap-6">
            <!-- Auth card -->
            <div class="space-y-3">
              <div class="flex items-center justify-between gap-2">
                <h3 class="text-sm sm:text-base font-semibold text-slate-50">
                  Login / Sign up
                </h3>
                <p class="text-[10px] text-slate-400">
                  Only organisers need an account.
                </p>
              </div>

              <div class="inline-flex rounded-full bg-slate-900/70 border border-slate-700 p-0.5 text-[11px]">
                <button id="loginTab"
                  class="flex-1 px-3 py-1.5 rounded-full text-center">
                  Login
                </button>
                <button id="signupTab"
                  class="flex-1 px-3 py-1.5 rounded-full text-center">
                  Sign up
                </button>
              </div>

              <form id="authForm" class="space-y-2 text-[11px] sm:text-xs">
                <div>
                  <label for="authEmail" class="block text-slate-300 mb-1">Email</label>
                  <input id="authEmail" type="email" required
                    class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-brand-400" />
                </div>
                <div>
                  <label for="authPassword" class="block text-slate-300 mb-1">Password</label>
                  <input id="authPassword" type="password" required
                    class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-brand-400" />
                </div>
                <p id="authError" class="text-[11px] text-red-400 min-h-[1.25rem]"></p>
                <button type="submit"
                  class="w-full rounded-2xl bg-brand-400 hover:bg-brand-300 text-slate-950 font-semibold py-2 text-xs sm:text-sm btn-glow">
                  Continue
                </button>
              </form>
            </div>

            <!-- organiserSection (hidden until login) -->
            <div id="organiserSection" class="space-y-3 hidden">
              <h3 class="text-sm sm:text-base font-semibold text-slate-50">
                Your tournaments
              </h3>
              <div class="grid sm:grid-cols-2 gap-3">
                <!-- Create tournament -->
                <div class="rounded-2xl border border-slate-800 bg-slate-950/90 p-3 space-y-2">
                  <h4 class="text-xs font-semibold text-slate-100 mb-1">
                    Create tournament
                  </h4>
                  <form id="createTournamentForm" class="space-y-2 text-[11px] sm:text-xs">
                    <div>
                      <label for="tName" class="block text-slate-300 mb-1">Tournament name</label>
                      <input id="tName" type="text" required
                        class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-brand-400" />
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                      <div>
                        <label for="tPlatform" class="block text-slate-300 mb-1">Platform</label>
                        <select id="tPlatform"
                          class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-3 py-2">
                          <option value="Mobile">Mobile</option>
                          <option value="PC">PC</option>
                          <option value="Console">Console</option>
                        </select>
                      </div>
                      <div>
                        <label for="tMode" class="block text-slate-300 mb-1">Mode</label>
                        <select id="tMode"
                          class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-3 py-2">
                          <option value="1v1">1v1</option>
                          <option value="2v2">2v2</option>
                          <option value="3v3">3v3</option>
                        </select>
                      </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                      <div>
                        <label for="tType" class="block text-slate-300 mb-1">Tournament type</label>
                        <select id="tType"
                          class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-3 py-2">
                          <option value="league">League</option>
                          <option value="knockout">Knockout</option>
                          <option value="groups_knockout">Groups + Knockout</option>
                        </select>
                      </div>
                      <div>
                        <label for="tStart" class="block text-slate-300 mb-1">Start date</label>
                        <input id="tStart" type="date"
                          class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-3 py-2" />
                      </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                      <div>
                        <label for="tMaxPlayers" class="block text-slate-300 mb-1">Max participants</label>
                        <input id="tMaxPlayers" type="number" value="16" min="2"
                          class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-3 py-2" />
                      </div>
                      <div>
                        <label class="block text-slate-300 mb-1">Payment type</label>
                        <select id="tPaidType"
                          class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-3 py-2">
                          <option value="free">Free</option>
                          <option value="paid">Paid</option>
                        </select>
                      </div>
                    </div>

                    <div id="paidFields" class="hidden space-y-2">
                      <div>
                        <label for="tEntryFee" class="block text-slate-300 mb-1">Entry fee (₹)</label>
                        <input id="tEntryFee" type="number" min="0"
                          class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-3 py-2" />
                      </div>
                      <div>
                        <label for="tPrizePool" class="block text-slate-300 mb-1">Prize pool (₹)</label>
                        <input id="tPrizePool" type="number" min="0"
                          class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-3 py-2" />
                      </div>
                    </div>

                    <div>
                      <label for="tNotes" class="block text-slate-300 mb-1">Notes / rules (optional)</label>
                      <textarea id="tNotes" rows="2"
                        class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-3 py-2 text-[11px]"></textarea>
                    </div>
                    <button type="submit"
                      class="w-full rounded-2xl bg-brand-400 hover:bg-brand-300 text-slate-950 font-semibold py-2 text-xs sm:text-sm btn-glow">
                      Create tournament
                    </button>
                  </form>
                </div>

                <!-- List + detail -->
                <div class="space-y-3">
                  <div class="rounded-2xl border border-slate-800 bg-slate-950/90 p-3 h-40 overflow-y-auto" id="tournamentList">
                    <p class="text-[11px] text-slate-400">No tournaments yet.</p>
                  </div>
                  <div class="rounded-2xl border border-slate-800 bg-slate-950/90 p-3 min-h-[140px]" id="tournamentDetail">
                    <p class="text-[11px] text-slate-400">Select a tournament to see fixtures, standings & share links.</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Placeholder when organiser not logged in -->
            <div id="organiserSectionPlaceholder" class="text-[11px] sm:text-xs text-slate-400">
              <p>This area shows your tournaments after you login.</p>
              <p class="mt-1">
                Create multiple events, send links to players, and watch fixtures + standings update in real time.
              </p>
            </div>
          </div>
        </section>

        <!-- Public View / Join -->
        <section id="publicSection"
          class="glass-panel rounded-3xl border border-slate-800/80 px-4 sm:px-6 py-4 sm:py-5 shadow-lg hidden">
          <div class="space-y-3">
            <div id="publicTournamentInfo" class="text-[11px] sm:text-xs text-slate-300">
              Loading tournament…
            </div>
            <div id="publicModeContent" class="mt-2 text-[11px] sm:text-xs"></div>
          </div>
        </section>
      </div>
    </main>

    <!-- Edit page overlay -->
    <div id="editPage"
      class="fixed inset-0 bg-slate-950/80 flex items-center justify-center z-30 hidden">
      <div class="w-full max-w-md mx-3 rounded-3xl border border-slate-800 bg-slate-950/95 p-4 sm:p-5">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-sm sm:text-base font-semibold text-slate-50">Edit tournament</h3>
          <button id="editCancelBtn"
            class="text-[11px] text-slate-400 hover:text-slate-200 px-2 py-1 rounded-full hover:bg-slate-800">
            Close
          </button>
        </div>
        <form id="editTournamentForm" class="space-y-2 text-[11px] sm:text-xs">
          <div>
            <label class="block text-slate-300 mb-1">Tournament name</label>
            <input id="edit_tName" type="text"
              class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-3 py-2" />
          </div>
          <div>
            <label class="block text-slate-300 mb-1">Start date</label>
            <input id="edit_tStart" type="date"
              class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-3 py-2" />
          </div>
          <div>
            <label class="block text-slate-300 mb-1">Max participants</label>
            <input id="edit_tMax" type="number" min="2"
              class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-3 py-2" />
          </div>
          <div>
            <label class="block text-slate-300 mb-1">Notes / rules</label>
            <textarea id="edit_tNotes" rows="2"
              class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-3 py-2 text-[11px]"></textarea>
          </div>
          <div class="flex justify-end gap-2 pt-2">
            <button type="button" id="editCancelBtn2"
              class="px-3 py-1.5 rounded-full bg-slate-900 border border-slate-700 text-[11px] text-slate-200 hover:bg-slate-800">
              Cancel
            </button>
            <button type="submit"
              class="px-3 py-1.5 rounded-full bg-brand-400 hover:bg-brand-300 text-slate-950 text-[11px] font-semibold btn-glow">
              Save changes
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Firebase logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      doc,
      addDoc,
      getDoc,
      getDocs,
      query,
      where,
      orderBy,
      serverTimestamp,
      updateDoc,
      deleteDoc,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";

    // ===== Firebase config =====
    const firebaseConfig = {
      apiKey: "AIzaSyBJmw5rvmN3DrDBUveGZlqHU3j-xmjKYSI",
      authDomain: "pes-tournament-e2a1a.firebaseapp.com",
      databaseURL: "https://pes-tournament-e2a1a-default-rtdb.firebaseio.com",
      projectId: "pes-tournament-e2a1a",
      storageBucket: "pes-tournament-e2a1a.firebasestorage.app",
      messagingSenderId: "966089960191",
      appId: "1:966089960191:web:bb61b49290e09585b27aca",
      measurementId: "G-YDWWJRZCNR"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // ===== Mode detection (organiser / public view / join) =====
    const params = new URLSearchParams(window.location.search);
    const viewId = params.get("view");
    const joinId = params.get("join");
    const mode   = viewId ? "view" : joinId ? "join" : "organiser";

    // ===== DOM references =====
    const headerModeTag        = document.getElementById("headerModeTag");
    const logoutBtn            = document.getElementById("logoutBtn");
    const heroSection          = document.getElementById("heroSection");
    const heroPrimaryBtn       = document.getElementById("heroPrimaryBtn");
    const heroSecondaryBtn     = document.getElementById("heroSecondaryBtn");
    const globalLoader         = document.getElementById("globalLoader");

    const authSection          = document.getElementById("authSection");
    const organiserSection     = document.getElementById("organiserSection");
    const organiserSectionPlaceholder = document.getElementById("organiserSectionPlaceholder");
    const publicSection        = document.getElementById("publicSection");
    const editPage             = document.getElementById("editPage");
    const editTournamentForm   = document.getElementById("editTournamentForm");
    const editCancelBtn        = document.getElementById("editCancelBtn");
    const editCancelBtn2       = document.getElementById("editCancelBtn2");

    const loginTab             = document.getElementById("loginTab");
    const signupTab            = document.getElementById("signupTab");
    const authForm             = document.getElementById("authForm");
    const authEmail            = document.getElementById("authEmail");
    const authPassword         = document.getElementById("authPassword");
    const authError            = document.getElementById("authError");

    const createTournamentForm = document.getElementById("createTournamentForm");
    const tournamentListEl     = document.getElementById("tournamentList");
    const tournamentDetailEl   = document.getElementById("tournamentDetail");

    const publicTournamentInfo = document.getElementById("publicTournamentInfo");
    const publicModeContent    = document.getElementById("publicModeContent");

    // ===== State =====
    let authMode              = "login";
    let currentUser           = null;
    let selectedTournamentId  = null;
    let currentTournaments    = [];
    let currentEditId         = null;
    let currentTournamentUnsubs = [];

    // ===== Helpers =====
    function showLoader() {
      globalLoader?.classList.remove("hidden");
    }
    function hideLoader() {
      globalLoader?.classList.add("hidden");
    }
    function showPopup(msg) {
      alert(msg);
    }

    // ===== Mode label in header =====
    if (mode === "organiser") {
      headerModeTag.classList.remove("hidden");
      headerModeTag.textContent = "Organiser Panel · Create & manage tournaments";
    } else if (mode === "view") {
      headerModeTag.classList.remove("hidden");
      headerModeTag.textContent = "Public View · Live tournament page";
    } else if (mode === "join") {
      headerModeTag.classList.remove("hidden");
      headerModeTag.textContent = "Player Join · Book your spot";
    }

    // ===== Hero buttons (organiser only) =====
    heroPrimaryBtn?.addEventListener("click", () => {
      if (mode !== "organiser") return;
      if (currentUser) {
        document.getElementById("createTournamentForm")?.scrollIntoView({ behavior: "smooth", block: "start" });
      } else {
        authSection?.scrollIntoView({ behavior: "smooth", block: "start" });
      }
    });
    heroSecondaryBtn?.addEventListener("click", () => {
      if (mode !== "organiser") return;
      authSection?.scrollIntoView({ behavior: "smooth", block: "nearest" });
    });

    // ===== Auth tab switching =====
    function setAuthMode(newMode) {
      authMode = newMode;
      if (newMode === "login") {
        loginTab.classList.add("bg-slate-800","border","border-slate-700","font-semibold","text-slate-50");
        signupTab.classList.remove("bg-slate-800","border","border-slate-700","font-semibold","text-slate-50");
        signupTab.classList.add("text-slate-300");
      } else {
        signupTab.classList.add("bg-slate-800","border","border-slate-700","font-semibold","text-slate-50");
        loginTab.classList.remove("bg-slate-800","border","border-slate-700","font-semibold","text-slate-50");
        loginTab.classList.add("text-slate-300");
      }
      authError.textContent = "";
    }
    setAuthMode("login");
    loginTab.addEventListener("click", () => setAuthMode("login"));
    signupTab.addEventListener("click", () => setAuthMode("signup"));

    // ===== Auth form submit =====
    authForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      authError.textContent = "";
      const email = authEmail.value.trim();
      const password = authPassword.value.trim();
      try {
        showLoader();
        if (authMode === "login") {
          await signInWithEmailAndPassword(auth, email, password);
        } else {
          await createUserWithEmailAndPassword(auth, email, password);
        }
      } catch (err) {
        authError.textContent = err.message || "Authentication error";
      } finally {
        hideLoader();
      }
    });

    // ===== Logout =====
    logoutBtn.addEventListener("click", async () => {
      showLoader();
      await signOut(auth);
      hideLoader();
    });

    // ===== Helpers for organiser =====
    function clearCurrentTournamentListeners() {
      currentTournamentUnsubs.forEach(unsub => {
        try { unsub(); } catch (_) {}
      });
      currentTournamentUnsubs = [];
    }

    async function loadTournamentsForUser(uid) {
      showLoader();
      try {
        const q = query(
          collection(db, "tournaments"),
          where("ownerUid", "==", uid),
          orderBy("createdAt", "desc")
        );
        const snap = await getDocs(q);
        currentTournaments = [];
        snap.forEach(d => currentTournaments.push({ id: d.id, ...d.data() }));
        renderTournamentList();
      } finally {
        hideLoader();
      }
    }

    function renderTournamentList() {
      tournamentListEl.innerHTML = "";
      if (!currentTournaments.length) {
        tournamentListEl.innerHTML =
          '<p class="text-slate-400 text-[11px]">No tournaments yet. Create your first event on the left.</p>';
        return;
      }

      currentTournaments.forEach(t => {
        const participantsCount =
          t.mode === "1v1" ? (t.playerCount || 0) : (t.teamCount || 0);

        const typeLabel =
          t.type === "league" ? "League" :
          t.type === "knockout" ? "Knockout" :
          t.type === "groups_knockout" ? "Groups + Knockout" :
          t.type;

        const paidLabel = t.paidType === "paid"
          ? `Paid • Entry ₹${t.entryFee || 0} • Pool ₹${t.prizePool || 0}`
          : "Free";

        const wrapper = document.createElement("div");
        wrapper.className =
          "rounded-2xl border border-slate-800 bg-slate-950/80 px-3 py-3 " +
          "flex flex-col sm:flex-row sm:items-start sm:justify-between gap-2 sm:gap-3 card-hover";

        wrapper.innerHTML = `
          <div class="min-w-0">
            <div class="font-semibold text-slate-50 text-[13px] sm:text-sm truncate flex items-center gap-1.5">
              <span class="inline-flex h-1.5 w-1.5 rounded-full bg-brand-400"></span>
              <span class="truncate">${t.name}</span>
            </div>
            <div class="text-[10px] sm:text-[11px] text-slate-400 mt-0.5 sm:mt-1 flex flex-wrap gap-x-2 gap-y-0.5">
              <span>${t.platform}</span>
              <span>• ${t.mode}</span>
              <span>• ${typeLabel}</span>
              <span>• ${paidLabel}</span>
              ${t.startDate ? `<span>• Starts ${t.startDate}</span>` : ""}
            </div>
            <div class="text-[10px] text-slate-500 mt-1">
              ${(t.mode === "1v1" ? "Players" : "Teams")}: ${participantsCount}
            </div>
          </div>
          <div class="flex items-center gap-1.5">
            <button class="btn-open px-3 py-1.5 rounded-full bg-brand-400 hover:bg-brand-300 text-slate-950 text-[10px] font-semibold shadow-brand-glow btn-glow">
              Open
            </button>
            <button class="btn-edit px-3 py-1.5 rounded-full bg-slate-800 hover:bg-slate-700 text-slate-50 text-[10px] font-semibold">
              Edit
            </button>
            <button class="btn-delete px-3 py-1.5 rounded-full bg-red-500/80 hover:bg-red-500 text-slate-50 text-[10px] font-semibold">
              Delete
            </button>
          </div>
        `;

        wrapper.querySelector(".btn-open").addEventListener("click", () => {
          selectedTournamentId = t.id;
          clearCurrentTournamentListeners();
          renderTournamentDetailRealtime();
        });

        wrapper.querySelector(".btn-edit").addEventListener("click", () => {
          openEditPage(t);
        });

        wrapper.querySelector(".btn-delete").addEventListener("click", async () => {
          const sure = confirm("Are you sure you want to delete this tournament? This cannot be undone.");
          if (!sure) return;
          showLoader();
          try {
            await deleteTournament(t.id);
            await loadTournamentsForUser(currentUser.uid);
            tournamentDetailEl.innerHTML = "<p class='text-[11px] text-slate-400'>Select a tournament.</p>";
          } finally {
            hideLoader();
          }
        });

        tournamentListEl.appendChild(wrapper);
      });
    }

    async function deleteTournament(tId) {
      const tRef = doc(db, "tournaments", tId);

      async function deleteSub(path) {
        const colRef = collection(db, "tournaments", tId, path);
        const snap = await getDocs(colRef);
        for (const d of snap.docs) {
          await deleteDoc(doc(db, "tournaments", tId, path, d.id));
        }
      }
      await deleteSub("players");
      await deleteSub("teams");
      await deleteSub("matches");
      await deleteDoc(tRef);
    }

    function openEditPage(t) {
      currentEditId = t.id;
      document.getElementById("edit_tName").value  = t.name || "";
      document.getElementById("edit_tNotes").value = t.notes || "";
      document.getElementById("edit_tStart").value = t.startDate || "";
      document.getElementById("edit_tMax").value   = t.maxParticipants || "";
      editPage.classList.remove("hidden");
    }
    function closeEditPage() {
      editPage.classList.add("hidden");
    }
    editCancelBtn.addEventListener("click", closeEditPage);
    editCancelBtn2.addEventListener("click", closeEditPage);

    editTournamentForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentEditId || !currentUser) return;

      const newData = {
        name:      document.getElementById("edit_tName").value.trim(),
        notes:     document.getElementById("edit_tNotes").value.trim(),
        startDate: document.getElementById("edit_tStart").value || null,
        maxParticipants: Number(document.getElementById("edit_tMax").value) || null
      };

      showLoader();
      try {
        await updateDoc(doc(db, "tournaments", currentEditId), newData);
        alert("Tournament updated successfully!");
        closeEditPage();
        await loadTournamentsForUser(currentUser.uid);
        if (selectedTournamentId === currentEditId) {
          clearCurrentTournamentListeners();
          await renderTournamentDetailRealtime();
        }
      } finally {
        hideLoader();
      }
    });

    function setActiveTab(buttons, active, panels) {
      const { overviewEl, participantsEl, matchesEl, standingsEl, bracketEl } = panels;
      buttons.forEach(btn => {
        const tab = btn.getAttribute("data-tab");
        if (tab === active) {
          btn.classList.add("border-b-2","border-brand-400","text-brand-200");
          btn.classList.remove("border-transparent","text-slate-400");
        } else {
          btn.classList.remove("border-b-2","border-brand-400","text-brand-200");
          btn.classList.add("border-transparent","text-slate-400");
        }
      });
      const map = {
        overview: overviewEl,
        participants: participantsEl,
        matches: matchesEl,
        standings: standingsEl,
        bracket: bracketEl
      };
      for (const [key, el] of Object.entries(map)) {
        if (!el) continue;
        if (key === active) el.classList.remove("hidden");
        else el.classList.add("hidden");
      }
    }

    function renderOverviewTab(container, t, viewLink, joinLink) {
      const typeLabel =
        t.type === "league" ? "League" :
        t.type === "knockout" ? "Knockout" :
        t.type === "groups_knockout" ? "Groups + Knockout" :
        t.type;

      const paidLabel = t.paidType === "paid"
        ? `Paid · Entry ₹${t.entryFee || 0} · Prize pool ₹${t.prizePool || 0}`
        : "Free tournament";

      container.innerHTML = `
        <div class="space-y-3 text-[11px] sm:text-xs">
          <div class="bg-slate-950 border border-slate-800 rounded-2xl px-3 py-2.5">
            <div class="font-semibold text-slate-200 mb-1 flex items-center gap-1.5">
              <span class="inline-flex h-1.5 w-1.5 rounded-full bg-brand-400"></span>
              <span>Share links</span>
            </div>
            <div class="space-y-1.5">
              <div class="flex flex-col sm:flex-row sm:items-center gap-1">
                <span class="text-slate-400 w-28 shrink-0">Public View:</span>
                <span class="break-all text-slate-100">${viewLink}</span>
              </div>
              <div class="flex flex-col sm:flex-row sm:items-center gap-1">
                <span class="text-slate-400 w-28 shrink-0">Player Join:</span>
                <span class="break-all text-slate-100">${joinLink}</span>
              </div>
            </div>
            <button id="btnExportPdf"
              class="mt-3 px-3 py-1.5 rounded-full bg-slate-900 border border-slate-700 text-[11px] text-slate-200 hover:bg-slate-800">
              Export fixtures (PDF)
            </button>
          </div>

          <div class="bg-slate-950 border border-slate-800 rounded-2xl px-3 py-2.5">
            <div class="font-semibold text-slate-200 mb-1">Settings</div>
            <ul class="text-slate-400 list-disc ml-4 space-y-1">
              <li>Platform: <span class="text-slate-100">${t.platform}</span></li>
              <li>Mode: <span class="text-slate-100">${t.mode}</span></li>
              <li>Type: <span class="text-slate-100">${typeLabel}</span></li>
              <li>Payment: <span class="text-slate-100">${paidLabel}</span></li>
              ${t.startDate ? `<li>Start date: <span class="text-slate-100">${t.startDate}</span></li>` : ""}
              ${t.maxParticipants ? `<li>Max participants: <span class="text-slate-100">${t.maxParticipants}</span></li>` : ""}
            </ul>
            ${t.notes ? `
              <div class="mt-2">
                <div class="text-slate-300 font-medium mb-1">Notes</div>
                <p class="text-slate-400">${t.notes}</p>
              </div>
            ` : ""}
          </div>
        </div>
      `;
      container.querySelector("#btnExportPdf")?.addEventListener("click", () => exportTournamentPdf(t));
    }

    function renderParticipantsTab(container, t, players, teams) {
      const playerRows = players.map((p, idx) => `
        <tr class="border-b border-slate-800">
          <td class="px-2 py-1 text-[11px] text-slate-500">${idx + 1}</td>
          <td class="px-2 py-1 text-xs sm:text-sm text-slate-100">${p.gameName || "-"}</td>
          <td class="px-2 py-1 text-[11px] text-slate-300">${p.realName || "-"}</td>
          <td class="px-2 py-1 text-[11px] text-slate-300">${p.gameId || "-"}</td>
          <td class="px-2 py-1 text-[11px] text-slate-300">${p.mobile || "-"}</td>
        </tr>
      `).join("");

      const teamRows = teams.map((tm, idx) => {
        const membersLines = (tm.members || []).map(m => `
          <div class="text-[11px] text-slate-200">
            ${m.gameName || "-"}
            <span class="text-slate-500">(${m.realName || "Unknown"}, ${m.gameId || "No ID"}, ${m.mobile || "No mobile"})</span>
          </div>
        `).join("");
        return `
          <tr class="border-b border-slate-800 align-top">
            <td class="px-2 py-1 text-[11px] text-slate-500">${idx + 1}</td>
            <td class="px-2 py-1 text-xs sm:text-sm text-slate-100">${tm.name}</td>
            <td class="px-2 py-1">${membersLines || '<span class="text-[11px] text-slate-500">No members yet</span>'}</td>
            <td class="px-2 py-1 text-[11px] text-slate-300">${tm.teamCode || "-"}</td>
          </tr>
        `;
      }).join("");

      container.innerHTML = `
        <div class="grid md:grid-cols-2 gap-4">
          <div class="space-y-2">
            <h4 class="font-semibold text-slate-100 text-xs sm:text-sm">Players (1v1)</h4>
            <div class="overflow-x-auto rounded-2xl border border-slate-800 bg-slate-950/90">
              <table class="min-w-full text-[11px] sm:text-xs">
                <thead class="bg-slate-900 text-slate-300">
                  <tr>
                    <th class="px-2 py-1 text-left w-6">#</th>
                    <th class="px-2 py-1 text-left">Game name</th>
                    <th class="px-2 py-1 text-left">Real name</th>
                    <th class="px-2 py-1 text-left">Game ID</th>
                    <th class="px-2 py-1 text-left">Mobile</th>
                  </tr>
                </thead>
                <tbody>
                  ${playerRows || `
                    <tr>
                      <td colspan="5" class="px-2 py-3 text-[11px] text-slate-500 text-center">
                        No players yet (used only in 1v1 tournaments).
                      </td>
                    </tr>
                  `}
                </tbody>
              </table>
            </div>
          </div>

          <div class="space-y-2">
            <h4 class="font-semibold text-slate-100 text-xs sm:text-sm">Teams (2v2 / 3v3)</h4>
            <div class="overflow-x-auto rounded-2xl border border-slate-800 bg-slate-950/90">
              <table class="min-w-full text-[11px] sm:text-xs">
                <thead class="bg-slate-900 text-slate-300">
                  <tr>
                    <th class="px-2 py-1 text-left w-6">#</th>
                    <th class="px-2 py-1 text-left">Team</th>
                    <th class="px-2 py-1 text-left">Members (Game name · Real name · Game ID · Mobile)</th>
                    <th class="px-2 py-1 text-left">Team code</th>
                  </tr>
                </thead>
                <tbody>
                  ${teamRows || `
                    <tr>
                      <td colspan="4" class="px-2 py-3 text-[11px] text-slate-500 text-center">
                        No teams yet (used in 2v2 / 3v3).
                      </td>
                    </tr>
                  `}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    function createSimpleFixtures(t, entities) {
      const isTeams = t.mode !== "1v1";
      const list = entities;
      const matches = [];
      let round = 1;
      let matchNum = 1;

      if (t.type === "knockout") {
        for (let i = 0; i < list.length; i += 2) {
          if (i + 1 >= list.length) break;
          const home = list[i];
          const away = list[i + 1];
          matches.push({
            type: "knockout",
            round,
            matchNumber: matchNum++,
            entityType: isTeams ? "team" : "player",
            homeId: home.id,
            homeName: home.displayName,
            awayId: away.id,
            awayName: away.displayName,
            homeScore: null,
            awayScore: null,
            status: "pending"
          });
        }
      } else {
        for (let i = 0; i < list.length; i++) {
          for (let j = i + 1; j < list.length; j++) {
            const home = list[i];
            const away = list[j];
            matches.push({
              type: t.type || "league",
              round,
              matchNumber: matchNum++,
              entityType: isTeams ? "team" : "player",
              homeId: home.id,
              homeName: home.displayName,
              awayId: away.id,
              awayName: away.displayName,
              homeScore: null,
              awayScore: null,
              status: "pending"
            });
          }
        }
      }
      return matches;
    }

    async function regenerateFixturesById(tournamentId, force = false) {
      const tRef = doc(db, "tournaments", tournamentId);
      const tSnap = await getDoc(tRef);
      if (!tSnap.exists()) return;

      const t = { id: tRef.id, ...tSnap.data() };

      const entities = [];
      if (t.mode === "1v1") {
        const pSnap = await getDocs(collection(tRef, "players"));
        pSnap.forEach(p => {
          const d = p.data();
          entities.push({
            id: p.id,
            displayName: d.gameName || d.realName || "Player"
          });
        });
      } else {
        const tmSnap = await getDocs(collection(tRef, "teams"));
        tmSnap.forEach(tm => {
          const d = tm.data();
          entities.push({
            id: tm.id,
            displayName: d.name || "Team"
          });
        });
      }

      const matchesRef = collection(tRef, "matches");

      if (entities.length < 2) {
        const old = await getDocs(matchesRef);
        for (const m of old.docs) {
          await deleteDoc(m.ref);
        }
        return;
      }

      const existingSnap = await getDocs(matchesRef);
      let hasCompleted = false;
      existingSnap.forEach(m => {
        const d = m.data();
        if (d.status === "completed") hasCompleted = true;
      });

      if (!force && hasCompleted) {
        console.log("Auto-fixtures: completed matches exist, skip auto regen.");
        return;
      }

      for (const m of existingSnap.docs) {
        await deleteDoc(m.ref);
      }

      const newMatches = createSimpleFixtures(
        t,
        entities.map(e => ({ id: e.id, displayName: e.displayName }))
      );

      for (const m of newMatches) {
        await addDoc(matchesRef, {
          ...m,
          createdAt: serverTimestamp()
        });
      }

      console.log(`Fixtures regenerated for ${t.name} — matches:`, newMatches.length);
    }

    function renderMatchesTable(wrapper, matches, t, docRef) {
      if (!wrapper) return;

      if (!matches || !matches.length) {
        wrapper.innerHTML = `
          <div class="px-3 py-3 text-[11px] text-slate-500 text-center">
            No matches generated yet. Fixtures are auto-created once there are 2 or more participants.
          </div>
        `;
        return;
      }

      let nextPendingId = null;
      for (const m of matches) {
        if (m.status !== "completed") {
          nextPendingId = m.id;
          break;
        }
      }

      const rows = matches.map((m, idx) => {
        const status = m.status || "pending";
        const statusClass =
          status === "completed"
            ? "text-emerald-300"
            : status === "live"
              ? "text-amber-300"
              : "text-slate-400";

        const rowHighlight = m.id === nextPendingId ? "bg-slate-900/60" : "";

        return `
          <tr class="border-b border-slate-800 ${rowHighlight}" data-match-row="${m.id}">
            <td class="px-2 py-1 text-[11px] text-slate-500">${idx + 1}</td>
            <td class="px-2 py-1 text-[11px] text-slate-400">${m.round || "-"}</td>
            <td class="px-2 py-1 text-[11px] sm:text-xs text-slate-200">
              ${m.homeName} <span class="text-slate-500">vs</span> ${m.awayName}
            </td>
            <td class="px-2 py-1">
              <div class="flex items-center gap-1 text-[11px]">
                <input type="number" min="0" step="1"
                  data-mid="${m.id}" data-side="home"
                  value="${m.homeScore ?? ""}"
                  class="w-12 rounded bg-slate-900 border border-slate-700 px-1 py-0.5 text-center" />
                <span>-</span>
                <input type="number" min="0" step="1"
                  data-mid="${m.id}" data-side="away"
                  value="${m.awayScore ?? ""}"
                  class="w-12 rounded bg-slate-900 border border-slate-700 px-1 py-0.5 text-center" />
              </div>
            </td>
            <td class="px-2 py-1 text-[11px] ${statusClass}">
              ${status}
            </td>
            <td class="px-2 py-1">
              <button data-mid="${m.id}"
                class="btn-save-match px-2 py-1 rounded-full bg-brand-400 hover:bg-brand-300 text-[11px] text-slate-950 font-semibold btn-glow">
                Save
              </button>
            </td>
          </tr>
        `;
      }).join("");

      wrapper.innerHTML = `
        <table class="min-w-full text-[11px] sm:text-xs">
          <thead class="bg-slate-900 text-slate-300">
            <tr>
              <th class="px-2 py-1 text-left w-6">#</th>
              <th class="px-2 py-1 text-left w-10">Rd</th>
              <th class="px-2 py-1 text-left">Match</th>
              <th class="px-2 py-1 text-left w-28">Score</th>
              <th class="px-2 py-1 text-left w-20">Status</th>
              <th class="px-2 py-1 text-left w-16">Action</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;

      const saveButtons = wrapper.querySelectorAll(".btn-save-match");
      saveButtons.forEach(btn => {
        btn.addEventListener("click", async () => {
          const mid = btn.getAttribute("data-mid");
          const homeInput = wrapper.querySelector(`input[data-mid="${mid}"][data-side="home"]`);
          const awayInput = wrapper.querySelector(`input[data-mid="${mid}"][data-side="away"]`);
          const homeScore = homeInput.value === "" ? null : Number(homeInput.value);
          const awayScore = awayInput.value === "" ? null : Number(awayInput.value);

          showLoader();
          try {
            await updateDoc(doc(docRef, "matches", mid), {
              homeScore,
              awayScore,
              status: (homeScore != null && awayScore != null) ? "completed" : "pending"
            });

            const row = wrapper.querySelector(`tr[data-match-row="${mid}"]`);
            if (row) {
              row.classList.add("match-updated");
              setTimeout(() => row.classList.remove("match-updated"), 600);
            }

            btn.textContent = "Saved";
            btn.classList.add("bg-emerald-400","text-slate-950");
            setTimeout(() => {
              btn.textContent = "Save";
              btn.classList.remove("bg-emerald-400","text-slate-950");
            }, 900);
          } finally {
            hideLoader();
          }
        });
      });
    }

    async function renderStandingsTab(container, t) {
      const docRef = doc(db, "tournaments", t.id);

      if (t.type !== "league" && t.type !== "groups_knockout") {
        container.innerHTML = `
          <p class="text-[11px] text-slate-400">
            Standings are calculated for <span class="text-slate-100">League</span> or <span class="text-slate-100">Groups + Knockout</span> tournaments.
          </p>
        `;
        return;
      }

      const isTeams = t.mode !== "1v1";
      const entities = [];

      if (isTeams) {
        const tmSnap = await getDocs(collection(docRef, "teams"));
        tmSnap.forEach(tm => entities.push({ id: tm.id, name: tm.data().name || "Team" }));
      } else {
        const pSnap = await getDocs(collection(docRef, "players"));
        pSnap.forEach(p => entities.push({ id: p.id, name: p.data().gameName || "Player" }));
      }

      if (!entities.length) {
        container.innerHTML = `
          <p class="text-[11px] text-slate-400">
            No participants yet. Standings appear after matches are played.
          </p>
        `;
        return;
      }

      const table = {};
      entities.forEach(e => {
        table[e.id] = { id:e.id, name:e.name, played:0, won:0, drawn:0, lost:0, gf:0, ga:0, pts:0 };
      });

      const mSnap = await getDocs(collection(docRef, "matches"));
      mSnap.forEach(m => {
        const d = m.data();
        if (d.status !== "completed") return;
        if (d.homeScore == null || d.awayScore == null) return;

        const home = table[d.homeId];
        const away = table[d.awayId];
        if (!home || !away) return;

        home.played++; away.played++;
        home.gf += d.homeScore; home.ga += d.awayScore;
        away.gf += d.awayScore; away.ga += d.homeScore;

        if (d.homeScore > d.awayScore) {
          home.won++; away.lost++; home.pts += 3;
        } else if (d.homeScore < d.awayScore) {
          away.won++; home.lost++; away.pts += 3;
        } else {
          home.drawn++; away.drawn++; home.pts++; away.pts++;
        }
      });

      const rowsArr = Object.values(table).map(r => ({ ...r, gd: r.gf - r.ga }));
      rowsArr.sort((a,b) => {
        if (b.pts !== a.pts) return b.pts - a.pts;
        if (b.gd !== a.gd) return b.gd - a.gd;
        return b.gf - a.gf;
      });

      const rowsHtml = rowsArr.map((r, idx) => `
        <tr class="border-b border-slate-800">
          <td class="px-2 py-1 text-[11px] text-slate-500">${idx + 1}</td>
          <td class="px-2 py-1 text-xs sm:text-sm text-slate-100">${r.name}</td>
          <td class="px-2 py-1 text-[11px] text-slate-300 text-center">${r.played}</td>
          <td class="px-2 py-1 text-[11px] text-slate-300 text-center">${r.won}</td>
          <td class="px-2 py-1 text-[11px] text-slate-300 text-center">${r.drawn}</td>
          <td class="px-2 py-1 text-[11px] text-slate-300 text-center">${r.lost}</td>
          <td class="px-2 py-1 text-[11px] text-slate-300 text-center">${r.gf}</td>
          <td class="px-2 py-1 text-[11px] text-slate-300 text-center">${r.ga}</td>
          <td class="px-2 py-1 text-[11px] text-slate-300 text-center">${r.gf - r.ga}</td>
          <td class="px-2 py-1 text-[11px] text-brand-200 font-semibold text-center">${r.pts}</td>
        </tr>
      `).join("");

      container.innerHTML = `
        <div class="space-y-2">
          <div class="flex items-center justify-between">
            <h4 class="font-semibold text-slate-100 text-xs sm:text-sm">League standings</h4>
            <p class="text-[10px] text-slate-400">
              Win = 3 pts · Draw = 1 pt · Loss = 0 pts
            </p>
          </div>
          <div class="overflow-x-auto rounded-2xl border border-slate-800 bg-slate-950/90">
            <table class="min-w-full text-[11px] sm:text-xs">
              <thead class="bg-slate-900 text-slate-300">
                <tr>
                  <th class="px-2 py-1 text-left w-6">#</th>
                  <th class="px-2 py-1 text-left">Name</th>
                  <th class="px-2 py-1 text-center w-8">P</th>
                  <th class="px-2 py-1 text-center w-8">W</th>
                  <th class="px-2 py-1 text-center w-8">D</th>
                  <th class="px-2 py-1 text-center w-8">L</th>
                  <th class="px-2 py-1 text-center w-8">GF</th>
                  <th class="px-2 py-1 text-center w-8">GA</th>
                  <th class="px-2 py-1 text-center w-8">GD</th>
                  <th class="px-2 py-1 text-center w-10">Pts</th>
                </tr>
              </thead>
              <tbody>
                ${rowsHtml || `
                  <tr>
                    <td colspan="10" class="px-2 py-3 text-[11px] text-slate-500 text-center">
                      No completed matches yet. Standings will update as results are saved.
                    </td>
                  </tr>
                `}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    async function generateKnockoutFromStandings(t, topN = 4) {
      const docRef = doc(db, "tournaments", t.id);
      const matchesRef = collection(docRef, "matches");

      const isTeams = t.mode !== "1v1";
      const entities = [];
      if (isTeams) {
        const tmSnap = await getDocs(collection(docRef, "teams"));
        tmSnap.forEach(tm => entities.push({ id: tm.id, name: tm.data().name || "Team" }));
      } else {
        const pSnap = await getDocs(collection(docRef, "players"));
        pSnap.forEach(p => entities.push({ id: p.id, name: p.data().gameName || "Player" }));
      }

      const table = {};
      entities.forEach(e => {
        table[e.id] = { id:e.id, name:e.name, played:0, won:0, drawn:0, lost:0, gf:0, ga:0, pts:0 };
      });

      const mSnap = await getDocs(matchesRef);
      mSnap.forEach(m => {
        const d = m.data();
        if (d.status !== "completed") return;
        if (d.homeScore == null || d.awayScore == null) return;

        const home = table[d.homeId];
        const away = table[d.awayId];
        if (!home || !away) return;

        home.played++; away.played++;
        home.gf += d.homeScore; home.ga += d.awayScore;
        away.gf += d.awayScore; away.ga += d.homeScore;

        if (d.homeScore > d.awayScore) {
          home.won++; away.lost++; home.pts += 3;
        } else if (d.homeScore < d.awayScore) {
          away.won++; home.lost++; away.pts += 3;
        } else {
          home.drawn++; away.drawn++; home.pts++; away.pts++;
        }
      });

      const rows = Object.values(table).map(r => ({ ...r, gd: r.gf - r.ga }));
      rows.sort((a,b) => {
        if (b.pts !== a.pts) return b.pts - a.pts;
        if (b.gd !== a.gd) return b.gd - a.gd;
        return b.gf - a.gf;
      });

      const qualified = rows.slice(0, topN);
      if (qualified.length < 2) {
        alert("Not enough qualified players/teams for knockout.");
        return;
      }

      for (let i = 0; i < qualified.length / 2; i++) {
        const home = qualified[i];
        const away = qualified[qualified.length - 1 - i];
        await addDoc(matchesRef, {
          type: "knockout",
          round: "Quarterfinal",
          matchNumber: 100 + i,
          entityType: isTeams ? "team" : "player",
          homeId: home.id,
          homeName: home.name,
          awayId: away.id,
          awayName: away.name,
          homeScore: null,
          awayScore: null,
          status: "pending",
          createdAt: serverTimestamp()
        });
      }
      alert("Knockout bracket created from standings!");
    }

    function renderBracketTab(container, t) {
      container.innerHTML = `
        <div class="space-y-2 text-[11px] sm:text-xs text-slate-400">
          <div class="flex items-center justify-between mb-1">
            <p>Use the current standings to create a simple knockout bracket.</p>
            <button id="btnFromStandings"
              class="px-3 py-1.5 rounded-full bg-brand-400 hover:bg-brand-300 text-slate-950 text-[11px] font-semibold btn-glow">
              Generate knockout from standings
            </button>
          </div>
          <p class="text-[10px] text-slate-500">
            This will create additional matches flagged as <span class="text-slate-200">type = "knockout"</span>.
          </p>
        </div>
      `;
      container.querySelector("#btnFromStandings")?.addEventListener("click", async () => {
        await generateKnockoutFromStandings(t, 4);
      });
    }

    async function exportTournamentPdf(t) {
      const { jsPDF } = window.jspdf;
      const docRef = doc(db, "tournaments", t.id);
      const pdf = new jsPDF();
      let line = 10;

      pdf.setFontSize(14);
      pdf.text(t.name || "Tournament", 10, line);
      line += 6;
      pdf.setFontSize(10);
      pdf.text(`Mode: ${t.mode} | Type: ${t.type} | Platform: ${t.platform}`, 10, line);
      line += 8;

      pdf.setFontSize(12);
      pdf.text("Fixtures", 10, line);
      line += 5;
      pdf.setFontSize(9);

      const mSnap = await getDocs(collection(docRef, "matches"));
      mSnap.forEach(m => {
        const d = m.data();
        const scoreTxt = (d.homeScore != null && d.awayScore != null) ? ` (${d.homeScore}-${d.awayScore})` : "";
        const txt = `M${d.matchNumber || "?"} [R${d.round || "-"}] ${d.homeName} vs ${d.awayName}${scoreTxt}`;
        pdf.text(txt, 10, line);
        line += 4;
        if (line > 280) { pdf.addPage(); line = 10; }
      });

      pdf.save((t.name || "tournament") + "_fixtures.pdf");
    }

    function generateTeamCode() {
      const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
      let code = "";
      for (let i = 0; i < 4; i++) {
        code += chars[Math.floor(Math.random() * chars.length)];
      }
      return code;
    }

    async function loadPublicTournament(tId, modeType) {
      showLoader();
      try {
        const docRef = doc(db, "tournaments", tId);
        const snap = await getDoc(docRef);
        if (!snap.exists()) {
          publicTournamentInfo.textContent = "Tournament not found.";
          return;
        }
        const t = { id: snap.id, ...snap.data() };

        const typeLabel =
          t.type === "league" ? "League" :
          t.type === "knockout" ? "Knockout" :
          t.type === "groups_knockout" ? "Groups + Knockout" :
          t.type;

        const paidLabel = t.paidType === "paid"
          ? `Paid • Entry ₹${t.entryFee || 0} • Prize pool ₹${t.prizePool || 0}`
          : "Free tournament";

        publicTournamentInfo.innerHTML = `
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
            <div>
              <h2 class="text-lg sm:text-xl font-semibold text-slate-50 mb-0.5 flex items-center gap-2">
                <span class="inline-flex h-6 w-6 rounded-full border border-brand-400/60 bg-brand-400/10 items-center justify-center text-[11px] text-brand-200">T</span>
                <span>${t.name}</span>
              </h2>
              <p class="text-[11px] text-slate-400 flex flex-wrap gap-x-2 gap-y-0.5">
                <span>${t.platform}</span>
                <span>• ${t.mode}</span>
                <span>• ${typeLabel}</span>
                <span>• ${paidLabel}</span>
                ${t.startDate ? `<span>• Starts ${t.startDate}</span>` : ""}
              </p>
              ${t.notes ? `<p class="text-[11px] text-slate-300 mt-1">${t.notes}</p>` : ""}
            </div>
            <div class="text-[11px] text-slate-400">
              Mode: <span class="text-brand-300 font-medium">${modeType === "view" ? "Viewer" : "Join"}</span>
            </div>
          </div>
        `;

        if (modeType === "view") {
          await renderPublicView(t);
        } else if (modeType === "join") {
          await renderPublicJoin(t);
        }
      } finally {
        hideLoader();
      }
    }

    async function renderPublicView(t) {
      const docRef = doc(db, "tournaments", t.id);
      const players = [];
      const teams   = [];

      if (t.mode === "1v1") {
        const pSnap = await getDocs(collection(docRef, "players"));
        pSnap.forEach(p => players.push({ id: p.id, ...p.data() }));
      } else {
        const tmSnap = await getDocs(collection(docRef, "teams"));
        tmSnap.forEach(tm => teams.push({ id: tm.id, ...tm.data() }));
      }

      const playerRows = players.map((p, idx) => `
        <tr class="border-b border-slate-800">
          <td class="px-2 py-1 text-[11px] text-slate-500">${idx + 1}</td>
          <td class="px-2 py-1 text-xs sm:text-sm">${p.gameName || "-"}</td>
        </tr>
      `).join("");

      const teamRows = teams.map((tm, idx) => {
        const membersNames = (tm.members || []).map(m => m.gameName || "-").join(", ");
        return `
          <tr class="border-b border-slate-800">
            <td class="px-2 py-1 text-[11px] text-slate-500">${idx + 1}</td>
            <td class="px-2 py-1 text-xs sm:text-sm">${tm.name}</td>
            <td class="px-2 py-1 text-[11px] text-slate-400">${membersNames || "-"}</td>
          </tr>
        `;
      }).join("");

      publicModeContent.innerHTML = `
        <div class="grid md:grid-cols-2 gap-4">
          <div class="space-y-2">
            <h3 class="font-semibold text-slate-100 text-xs sm:text-sm">Players</h3>
            <div class="overflow-x-auto rounded-2xl border border-slate-800 bg-slate-950/90">
              <table class="min-w-full text-[11px] sm:text-xs">
                <thead class="bg-slate-900 text-slate-300">
                  <tr>
                    <th class="px-2 py-1 text-left w-6">#</th>
                    <th class="px-2 py-1 text-left">Game name</th>
                  </tr>
                </thead>
                <tbody>
                  ${playerRows || `
                    <tr>
                      <td colspan="2" class="px-2 py-3 text-[11px] text-slate-500 text-center">
                        No players registered yet.
                      </td>
                    </tr>
                  `}
                </tbody>
              </table>
            </div>
          </div>
          <div class="space-y-2">
            <h3 class="font-semibold text-slate-100 text-xs sm:text-sm">Teams</h3>
            <div class="overflow-x-auto rounded-2xl border border-slate-800 bg-slate-950/90">
              <table class="min-w-full text-[11px] sm:text-xs">
                <thead class="bg-slate-900 text-slate-300">
                  <tr>
                    <th class="px-2 py-1 text-left w-6">#</th>
                    <th class="px-2 py-1 text-left">Team</th>
                    <th class="px-2 py-1 text-left">Members (Game name)</th>
                  </tr>
                </thead>
                <tbody>
                  ${teamRows || `
                    <tr>
                      <td colspan="3" class="px-2 py-3 text-[11px] text-slate-500 text-center">
                        No teams registered yet.
                      </td>
                    </tr>
                  `}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    async function renderPublicJoin(t) {
      const docRef = doc(db, "tournaments", t.id);

      const joinContentFor1v1 = `
        <div class="space-y-3">
          <div>
            <h3 class="font-semibold text-slate-100 text-sm">Join as player (1v1)</h3>
            <p id="public-slots-left" class="text-[11px] text-slate-400 mt-1"></p>
          </div>
          <form id="joinPlayerForm" class="space-y-2 text-[11px] sm:text-xs">
            <div>
              <label class="block text-slate-300 mb-1">Real name</label>
              <input id="joinRealName" type="text" required
                     class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-brand-400" />
            </div>
            <div>
              <label class="block text-slate-300 mb-1">Game name (shown in tournament)</label>
              <input id="joinGameName" type="text" required
                     class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-brand-400" />
            </div>
            <div>
              <label class="block text-slate-300 mb-1">Game ID</label>
              <input id="joinGameId" type="text" required
                     class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-brand-400" />
            </div>
            <div>
              <label class="block text-slate-300 mb-1">Mobile number</label>
              <input id="joinMobile" type="tel" required
                     class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-brand-400" />
            </div>
            <p id="joinPlayerMsg" class="text-[11px] text-emerald-300 min-h-[1.25rem]"></p>
            <button type="submit"
                    class="w-full rounded-2xl bg-brand-400 hover:bg-brand-300 text-slate-950 font-semibold py-2 text-xs sm:text-sm shadow-brand-glow btn-glow">
              Book my spot
            </button>
          </form>
        </div>
      `;

      const teamSize = t.mode === "2v2" ? 2 : 3;
      const joinContentForTeams = `
        <div class="space-y-4">
          <div>
            <h3 class="font-semibold text-slate-100 text-sm">Team registration (${t.mode})</h3>
            <p id="public-slots-left" class="text-[11px] text-slate-400 mt-1"></p>
          </div>
          <div class="grid md:grid-cols-2 gap-4">
            <div class="space-y-2">
              <h4 class="font-semibold text-slate-100 text-xs">Create team (captain)</h4>
              <form id="createTeamForm" class="space-y-2 text-[11px] sm:text-xs">
                <div>
                  <label class="block text-slate-300 mb-1">Team name</label>
                  <input id="teamNameJoin" type="text" required
                         class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-brand-400" />
                </div>
                <div>
                  <label class="block text-slate-300 mb-1">Captain real name</label>
                  <input id="teamCaptainRealNameJoin" type="text" required
                         class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-brand-400" />
                </div>
                <div>
                  <label class="block text-slate-300 mb-1">Captain game name</label>
                  <input id="teamCaptainGameNameJoin" type="text" required
                         class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-brand-400" />
                </div>
                <div>
                  <label class="block text-slate-300 mb-1">Captain game ID</label>
                  <input id="teamCaptainGameIdJoin" type="text" required
                         class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-brand-400" />
                </div>
                <div>
                  <label class="block text-slate-300 mb-1">Captain mobile</label>
                  <input id="teamCaptainMobileJoin" type="tel" required
                         class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-brand-400" />
                </div>
                <p class="text-[10px] text-slate-400">
                  A team code will be generated. Share it with teammates so they can join using their own details.
                </p>
                <p id="createTeamMsg" class="text-[11px] text-emerald-300 min-h-[1.25rem]"></p>
                <button type="submit"
                        class="w-full rounded-2xl bg-brand-400 hover:bg-brand-300 text-slate-950 font-semibold py-2 text-xs sm:text-sm shadow-brand-glow btn-glow">
                  Create team
                </button>
              </form>
            </div>

            <div class="space-y-2">
              <h4 class="font-semibold text-slate-100 text-xs">Join existing team</h4>
              <form id="joinTeamForm" class="space-y-2 text-[11px] sm:text-xs">
                <div>
                  <label class="block text-slate-300 mb-1">Real name</label>
                  <input id="joinTeamRealName" type="text" required
                         class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-brand-400" />
                </div>
                <div>
                  <label class="block text-slate-300 mb-1">Game name</label>
                  <input id="joinTeamGameName" type="text" required
                         class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-brand-400" />
                </div>
                <div>
                  <label class="block text-slate-300 mb-1">Game ID</label>
                  <input id="joinTeamGameId" type="text" required
                         class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-brand-400" />
                </div>
                <div>
                  <label class="block text-slate-300 mb-1">Mobile</label>
                  <input id="joinTeamMobile" type="tel" required
                         class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-brand-400" />
                </div>
                <div>
                  <label class="block text-slate-300 mb-1">Team code</label>
                  <input id="joinTeamCode" type="text" required
                         class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-3 py-2 uppercase focus:outline-none focus:ring-1 focus:ring-brand-400" />
                </div>
                <p id="joinTeamMsg" class="text-[11px] text-emerald-300 min-h-[1.25rem]"></p>
                <button type="submit"
                        class="w-full rounded-2xl bg-brand-400 hover:bg-brand-300 text-slate-950 font-semibold py-2 text-xs sm:text-sm shadow-brand-glow btn-glow">
                  Join team
                </button>
              </form>
            </div>
          </div>
        </div>
      `;

      if (t.mode === "1v1") {
        publicModeContent.innerHTML = joinContentFor1v1;
      } else {
        publicModeContent.innerHTML = joinContentForTeams;
      }

      // LIVE slots left
      onSnapshot(docRef, (snap) => {
        const data = snap.data();
        if (!data) return;
        const max = data.maxParticipants || 0;
        const current = (t.mode === "1v1")
          ? (data.playerCount || 0)
          : (data.teamCount || 0);
        const slotsLeft = max ? (max - current) : null;

        const infoBox = document.getElementById("public-slots-left");
        if (infoBox) {
          infoBox.innerHTML = max
            ? `<span class="text-brand-300 font-semibold">${slotsLeft}</span> spots remaining (of ${max})`
            : `Open registration (no limit set by organiser).`;
        }
      });

      // 1v1 join
      if (t.mode === "1v1") {
        const joinForm       = document.getElementById("joinPlayerForm");
        const realNameInput  = document.getElementById("joinRealName");
        const gameNameInput  = document.getElementById("joinGameName");
        const gameIdInput    = document.getElementById("joinGameId");
        const mobileInput    = document.getElementById("joinMobile");
        const msg            = document.getElementById("joinPlayerMsg");

        joinForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          msg.textContent = "";

          const realName = realNameInput.value.trim();
          const gameName = gameNameInput.value.trim();
          const gameId   = gameIdInput.value.trim();
          const mobile   = mobileInput.value.trim();

          if (!realName || !gameName || !gameId || !mobile) {
            msg.textContent = "Please fill all fields.";
            return;
          }

          showLoader();
          try {
            const latestSnap = await getDoc(docRef);
            const data = latestSnap.data() || {};
            const max = data.maxParticipants || 0;
            const currentPlayers = data.playerCount || 0;

            if (max && currentPlayers >= max) {
              msg.textContent = "No spots remaining.";
              hideLoader();
              return;
            }

            await addDoc(collection(docRef, "players"), {
              realName,
              gameName,
              gameId,
              mobile,
              createdAt: serverTimestamp()
            });

            await updateDoc(docRef, { playerCount: currentPlayers + 1 });
            await regenerateFixturesById(t.id);

            showPopup("Your spot has been successfully booked!");
            msg.textContent = "Spot booked successfully!";
            realNameInput.value = "";
            gameNameInput.value = "";
            gameIdInput.value   = "";
            mobileInput.value   = "";
          } finally {
            hideLoader();
          }
        });
      } else {
        // Teams join & create
        const createTeamForm            = document.getElementById("createTeamForm");
        const createTeamMsg             = document.getElementById("createTeamMsg");
        const teamNameJoin              = document.getElementById("teamNameJoin");
        const teamCaptainRealNameJoin   = document.getElementById("teamCaptainRealNameJoin");
        const teamCaptainGameNameJoin   = document.getElementById("teamCaptainGameNameJoin");
        const teamCaptainGameIdJoin     = document.getElementById("teamCaptainGameIdJoin");
        const teamCaptainMobileJoin     = document.getElementById("teamCaptainMobileJoin");

        createTeamForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          createTeamMsg.textContent = "";

          const teamName  = teamNameJoin.value.trim();
          const capReal   = teamCaptainRealNameJoin.value.trim();
          const capGName  = teamCaptainGameNameJoin.value.trim();
          const capGId    = teamCaptainGameIdJoin.value.trim();
          const capMobile = teamCaptainMobileJoin.value.trim();

          if (!teamName || !capReal || !capGName || !capGId || !capMobile) {
            createTeamMsg.textContent = "All captain fields are required.";
            return;
          }

          showLoader();
          try {
            const latestSnap = await getDoc(docRef);
            const data = latestSnap.data() || {};
            const max = data.maxParticipants || 0;
            const currentTeams = data.teamCount || 0;

            if (max && currentTeams >= max) {
              createTeamMsg.textContent = "No team slots remaining.";
              hideLoader();
              return;
            }

            const teamCode = generateTeamCode();

            await addDoc(collection(docRef, "teams"), {
              name: teamName,
              members: [{
                realName: capReal,
                gameName: capGName,
                gameId:   capGId,
                mobile:   capMobile
              }],
              teamCode,
              maxSize: teamSize,
              createdAt: serverTimestamp()
            });

            await updateDoc(docRef, { teamCount: currentTeams + 1 });
            await regenerateFixturesById(t.id);

            showPopup("Team created successfully! Share the team code with your teammates.");
            createTeamMsg.textContent =
              `Team created! Share this team code with your teammates: ${teamCode}`;
            teamNameJoin.value              = "";
            teamCaptainRealNameJoin.value   = "";
            teamCaptainGameNameJoin.value   = "";
            teamCaptainGameIdJoin.value     = "";
            teamCaptainMobileJoin.value     = "";
          } finally {
            hideLoader();
          }
        });

        const joinTeamForm   = document.getElementById("joinTeamForm");
        const joinTeamReal   = document.getElementById("joinTeamRealName");
        const joinTeamGName  = document.getElementById("joinTeamGameName");
        const joinTeamGId    = document.getElementById("joinTeamGameId");
        const joinTeamMobile = document.getElementById("joinTeamMobile");
        const joinTeamCode   = document.getElementById("joinTeamCode");
        const joinTeamMsg    = document.getElementById("joinTeamMsg");

        joinTeamForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          joinTeamMsg.textContent = "";

          const realName = joinTeamReal.value.trim();
          const gameName = joinTeamGName.value.trim();
          const gameId   = joinTeamGId.value.trim();
          const mobile   = joinTeamMobile.value.trim();
          const code     = joinTeamCode.value.trim().toUpperCase();

          if (!realName || !gameName || !gameId || !mobile || !code) {
            joinTeamMsg.textContent = "All fields are required.";
            return;
          }

          showLoader();
          try {
            const tmSnap = await getDocs(
              query(collection(docRef, "teams"), where("teamCode", "==", code))
            );
            if (tmSnap.empty) {
              joinTeamMsg.textContent = "Invalid team code.";
              return;
            }
            const teamDoc = tmSnap.docs[0];
            const teamData = teamDoc.data();
            const members = teamData.members || [];
            const maxSize = teamData.maxSize || teamSize;

            if (members.length >= maxSize) {
              joinTeamMsg.textContent = "Team is already full.";
              return;
            }

            if (members.find(m =>
              m.gameName.toLowerCase() === gameName.toLowerCase() &&
              m.realName.toLowerCase() === realName.toLowerCase()
            )) {
              joinTeamMsg.textContent = "You are already in this team.";
              return;
            }

            members.push({ realName, gameName, gameId, mobile });
            await updateDoc(teamDoc.ref, { members });

            showPopup("You successfully joined the team!");
            joinTeamMsg.textContent = "You have joined the team successfully!";
            joinTeamReal.value   = "";
            joinTeamGName.value  = "";
            joinTeamGId.value    = "";
            joinTeamMobile.value = "";
            joinTeamCode.value   = "";
          } finally {
            hideLoader();
          }
        });
      }
    }

    async function renderTournamentDetailRealtime() {
      if (!selectedTournamentId) {
        tournamentDetailEl.innerHTML =
          "<p class='text-[11px] text-slate-400'>Select a tournament.</p>";
        return;
      }
      const tid = selectedTournamentId;
      const tRef = doc(db, "tournaments", tid);

      showLoader();
      try {
        const snap = await getDoc(tRef);
        if (!snap.exists()) {
          tournamentDetailEl.innerHTML =
            "<p class='text-[11px] text-red-300'>Tournament not found.</p>";
          return;
        }
        const t = { id: snap.id, ...snap.data() };

        const baseUrl = window.location.origin + window.location.pathname;
        const viewLink = `${baseUrl}?view=${t.id}`;
        const joinLink = `${baseUrl}?join=${t.id}`;
        const typeLabel =
          t.type === "league" ? "League" :
          t.type === "knockout" ? "Knockout" :
          t.type === "groups_knockout" ? "Groups + Knockout" :
          t.type;

        tournamentDetailEl.innerHTML = `
          <div class="flex flex-col gap-4">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
              <div class="min-w-0">
                <h3 class="text-lg sm:text-xl font-semibold text-slate-50 truncate flex items-center gap-2">
                  <span class="inline-flex h-6 w-6 rounded-full border border-brand-400/60 bg-brand-400/10 items-center justify-center text-[11px] text-brand-200">T</span>
                  <span class="truncate">${t.name}</span>
                </h3>
                <p class="text-[11px] text-slate-400 mt-1 flex flex-wrap gap-x-2 gap-y-0.5">
                  <span>${t.platform}</span>
                  <span>• ${t.mode}</span>
                  <span>• ${typeLabel}</span>
                  ${t.startDate ? `<span>• Starts ${t.startDate}</span>` : ""}
                </p>
              </div>
              <div class="text-[11px] text-slate-400">
                <span id="participantLabel"></span>
              </div>
            </div>

            <div class="border-b border-slate-800 flex flex-wrap gap-2 text-[11px] sm:text-xs">
              <button data-tab="overview"
                class="t-tab-btn px-3 py-1.5 rounded-t-lg border-b-2 border-brand-400 text-brand-200 bg-slate-950">
                Overview
              </button>
              <button data-tab="participants"
                class="t-tab-btn px-3 py-1.5 rounded-t-lg border-b-2 border-transparent text-slate-400 hover:text-slate-200">
                Players & Teams
              </button>
              <button data-tab="matches"
                class="t-tab-btn px-3 py-1.5 rounded-t-lg border-b-2 border-transparent text-slate-400 hover:text-slate-200">
                Match center
              </button>
              <button data-tab="standings"
                class="t-tab-btn px-3 py-1.5 rounded-t-lg border-b-2 border-transparent text-slate-400 hover:text-slate-200">
                Standings
              </button>
              <button data-tab="bracket"
                class="t-tab-btn px-3 py-1.5 rounded-t-lg border-b-2 border-transparent text-slate-400 hover:text-slate-200">
                Bracket
              </button>
            </div>

            <div class="mt-3 space-y-4">
              <div id="tab-overview"     class="t-tab-panel"></div>
              <div id="tab-participants" class="t-tab-panel hidden"></div>
              <div id="tab-matches"      class="t-tab-panel hidden"></div>
              <div id="tab-standings"    class="t-tab-panel hidden"></div>
              <div id="tab-bracket"      class="t-tab-panel hidden"></div>
            </div>
          </div>
        `;

        const tabButtons      = tournamentDetailEl.querySelectorAll(".t-tab-btn");
        const overviewEl      = document.getElementById("tab-overview");
        const participantsEl  = document.getElementById("tab-participants");
        const matchesEl       = document.getElementById("tab-matches");
        const standingsEl     = document.getElementById("tab-standings");
        const bracketEl       = document.getElementById("tab-bracket");
        const participantLabel= document.getElementById("participantLabel");

        renderOverviewTab(overviewEl, t, viewLink, joinLink);
        renderBracketTab(bracketEl, t);

        tabButtons.forEach(btn => {
          btn.addEventListener("click", () => {
            const tab = btn.getAttribute("data-tab");
            setActiveTab(tabButtons, tab, {
              overviewEl,
              participantsEl,
              matchesEl,
              standingsEl,
              bracketEl
            });
          });
        });

        matchesEl.innerHTML = `
          <div class="space-y-3 text-[11px] sm:text-xs">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
              <div>
                <h4 class="font-semibold text-slate-100 text-sm">Match center</h4>
                <p class="text-slate-400">
                  Fixtures auto-generate based on participants. You can override them manually if needed.
                </p>
              </div>
              <div class="flex flex-wrap gap-2">
                <button id="btnGenerateFixtures"
                  class="px-3 py-1.5 rounded-full bg-brand-400 hover:bg-brand-300 text-slate-950 font-semibold shadow-brand-glow btn-glow">
                  Regenerate fixtures (manual)
                </button>
              </div>
            </div>
            <div id="matchesTableWrapper" class="overflow-x-auto rounded-2xl border border-slate-800 bg-slate-950/90"></div>
          </div>
        `;
        const btnGenerate    = matchesEl.querySelector("#btnGenerateFixtures");
        const matchesWrapper = matchesEl.querySelector("#matchesTableWrapper");

        let currentPlayers = [];
        let currentTeams   = [];
        let currentMatches = [];

        const unsubPlayers = onSnapshot(
          collection(tRef, "players"),
          async snap => {
            currentPlayers = [];
            snap.forEach(d => currentPlayers.push({ id: d.id, ...d.data() }));

            const label = (t.mode === "1v1" ? "Players" : "Teams");
            const count = (t.mode === "1v1" ? currentPlayers.length : currentTeams.length);
            participantLabel.textContent = `${label}: ${count}`;

            renderParticipantsTab(participantsEl, t, currentPlayers, currentTeams);

            if (t.mode === "1v1") {
              try {
                await regenerateFixturesById(t.id);
              } catch (err) {
                console.error("Auto fixture regen (players) error:", err);
              }
            }
          }
        );

        const unsubTeams = onSnapshot(
          collection(tRef, "teams"),
          async snap => {
            currentTeams = [];
            snap.forEach(d => currentTeams.push({ id: d.id, ...d.data() }));

            const label = (t.mode === "1v1" ? "Players" : "Teams");
            const count = (t.mode === "1v1" ? currentPlayers.length : currentTeams.length);
            participantLabel.textContent = `${label}: ${count}`;

            renderParticipantsTab(participantsEl, t, currentPlayers, currentTeams);

            if (t.mode !== "1v1") {
              try {
                await regenerateFixturesById(t.id);
              } catch (err) {
                console.error("Auto fixture regen (teams) error:", err);
              }
            }
          }
        );

        const unsubMatches = onSnapshot(
          query(collection(tRef, "matches"), orderBy("round","asc")),
          async snap => {
            currentMatches = [];
            snap.forEach(d => currentMatches.push({ id: d.id, ...d.data() }));
            renderMatchesTable(matchesWrapper, currentMatches, t, tRef);
            await renderStandingsTab(standingsEl, t);
          }
        );

        currentTournamentUnsubs.push(unsubPlayers, unsubTeams, unsubMatches);

        btnGenerate.addEventListener("click", async () => {
          const ok = confirm(
            "This will recreate all fixtures and may clear existing results. Continue?"
          );
          if (!ok) return;

          showLoader();
          try {
            await regenerateFixturesById(t.id, true);
          } finally {
            hideLoader();
          }
        });

        renderParticipantsTab(participantsEl, t, currentPlayers, currentTeams);
        await renderStandingsTab(standingsEl, t);

      } finally {
        hideLoader();
      }
    }

    // ===== Create tournament (organiser) =====
    createTournamentForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser) return;

      const name     = document.getElementById("tName").value.trim();
      const platform = document.getElementById("tPlatform").value;
      const modeVal  = document.getElementById("tMode").value;
      const typeVal  = document.getElementById("tType").value;
      const startDate= document.getElementById("tStart").value;
      const maxPart  = Number(document.getElementById("tMaxPlayers").value) || null;
      const notes    = document.getElementById("tNotes").value.trim();

      const paidType   = document.getElementById("tPaidType")?.value || "free";
      const entryFee   = paidType === "paid"
        ? Number(document.getElementById("tEntryFee")?.value || 0)
        : 0;
      const prizePool  = paidType === "paid"
        ? Number(document.getElementById("tPrizePool")?.value || 0)
        : 0;

      if (!name) {
        alert("Please enter a tournament name.");
        return;
      }

      showLoader();
      try {
        const docRef = await addDoc(collection(db, "tournaments"), {
          name,
          platform,
          mode: modeVal,
          type: typeVal,
          startDate: startDate || null,
          maxParticipants: maxPart,
          notes,

          // owner + admin list
          ownerUid: currentUser.uid,
          adminList: [currentUser.uid],

          // paid/free info
          paidType,
          entryFee,
          prizePool,

          // counters
          playerCount: 0,
          teamCount: 0,

          createdAt: serverTimestamp()
        });
        await loadTournamentsForUser(currentUser.uid);
        selectedTournamentId = docRef.id;
        clearCurrentTournamentListeners();
        await renderTournamentDetailRealtime();
        e.target.reset();
        document.getElementById("tMaxPlayers").value = 16;
        if (document.getElementById("tPaidType")) {
          document.getElementById("tPaidType").value = "free";
          document.getElementById("paidFields")?.classList.add("hidden");
        }
      } finally {
        hideLoader();
      }
    });

    // Show/hide paid fields
    const paidTypeSelect = document.getElementById("tPaidType");
    if (paidTypeSelect) {
      paidTypeSelect.addEventListener("change", (e) => {
        const v = e.target.value;
        document.getElementById("paidFields")?.classList.toggle("hidden", v === "free");
      });
    }

    // ===== Auth state listener =====
    onAuthStateChanged(auth, async (user) => {
      showLoader();
      try {
        currentUser = user || null;

        if (mode === "organiser") {
          publicSection.classList.add("hidden");
          if (!currentUser) {
            heroSection?.classList.remove("hidden");
            authSection.classList.remove("hidden");
            organiserSection.classList.add("hidden");
            organiserSectionPlaceholder.classList.remove("hidden");
            logoutBtn.classList.add("hidden");
          } else {
            heroSection?.classList.remove("hidden");
            authSection.classList.remove("hidden");
            organiserSection.classList.remove("hidden");
            organiserSectionPlaceholder.classList.add("hidden");
            logoutBtn.classList.remove("hidden");
            await loadTournamentsForUser(currentUser.uid);
          }
        } else {
          heroSection?.classList.add("hidden");
          authSection.classList.add("hidden");
          organiserSection.classList.add("hidden");
          organiserSectionPlaceholder.classList.add("hidden");
          logoutBtn.classList.add("hidden");
          publicSection.classList.remove("hidden");

          if (mode === "view" && viewId) {
            await loadPublicTournament(viewId, "view");
          } else if (mode === "join" && joinId) {
            await loadPublicTournament(joinId, "join");
          } else {
            publicTournamentInfo.textContent = "Invalid or missing tournament id.";
          }
        }
      } finally {
        hideLoader();
      }
    });
  </script>
</body>
</html>
