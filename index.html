<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Efootball Tournament Platform by PesPagol</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Tailwind config -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              100: "#E0F2FE",
              200: "#BAE6FD",
              300: "#7DD3FC",
              400: "#22D3EE",
            },
          },
          boxShadow: {
            "brand-glow": "0 0 35px rgba(34,211,238,0.35)",
          },
        },
      },
    };
  </script>

  <!-- jsPDF for fixture export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>

  <!-- Firebase (compat version for easier usage) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at top left, rgba(34,211,238,0.15), transparent 55%),
        radial-gradient(circle at bottom right, rgba(56,189,248,0.12), transparent 55%),
        #020617;
    }

    /* Custom scrollbar (optional) */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #020617;
    }
    ::-webkit-scrollbar-thumb {
      background: #1f2937;
      border-radius: 999px;
    }
  </style>
</head>

<body class="min-h-screen text-slate-100">
  <!-- Page wrapper -->
  <div class="min-h-screen flex flex-col">

    <!-- Top navbar -->
    <header class="border-b border-slate-800/60 bg-slate-950/60 backdrop-blur sticky top-0 z-20">
      <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <div class="h-9 w-9 rounded-xl bg-cyan-400/10 border border-cyan-400/40 flex items-center justify-center shadow-brand-glow">
            <span class="text-cyan-300 font-semibold text-lg">P</span>
          </div>
          <div>
            <h1 class="text-lg sm:text-xl font-semibold tracking-tight">
              PesPagol <span class="text-cyan-300">Tournament Hub</span>
            </h1>
            <p class="text-xs text-slate-400 -mt-0.5">
              Manage your eFootball tournaments in one place
            </p>
          </div>
        </div>

        <span class="hidden sm:inline-flex text-xs rounded-full border border-cyan-400/30 px-3 py-1 text-cyan-100 bg-cyan-400/5">
          Admin Console
        </span>
      </div>
    </header>

    <!-- Main content -->
    <main class="flex-1">
      <div class="max-w-6xl mx-auto px-4 py-6 md:py-10 space-y-6">

        <!-- Status / toast -->
        <div id="statusMessage" class="hidden rounded-xl border border-emerald-400/40 bg-emerald-500/10 text-emerald-100 px-4 py-3 text-sm shadow-brand-glow"></div>

        <div class="grid lg:grid-cols-5 gap-6">
          <!-- Left: Tournament + Teams -->
          <section class="lg:col-span-2 space-y-4">
            <!-- Tournament setup card -->
            <div class="rounded-2xl bg-slate-900/70 border border-slate-700/80 shadow-xl shadow-cyan-500/5 p-4 sm:p-5">
              <h2 class="text-base sm:text-lg font-semibold mb-3 flex items-center justify-between">
                <span>Tournament Details</span>
                <span class="text-xs font-normal text-slate-400">Step 1 of 2</span>
              </h2>

              <div class="space-y-3">
                <div>
                  <label for="tournamentName" class="block text-xs font-medium text-slate-300 mb-1.5">
                    Tournament Name
                  </label>
                  <input
                    id="tournamentName"
                    type="text"
                    placeholder="e.g., PesPagol Champions Cup"
                    class="w-full rounded-xl bg-slate-900/90 border border-slate-600/70 focus:border-cyan-400 focus:ring-1 focus:ring-cyan-400/70 px-3 py-2 text-sm outline-none"
                  />
                </div>

                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label for="tournamentType" class="block text-xs font-medium text-slate-300 mb-1.5">
                      Format
                    </label>
                    <select
                      id="tournamentType"
                      class="w-full rounded-xl bg-slate-900/90 border border-slate-600/70 focus:border-cyan-400 focus:ring-1 focus:ring-cyan-400/70 px-3 py-2 text-xs outline-none"
                    >
                      <option value="league">League (Round Robin)</option>
                      <option value="knockout">Knockout</option>
                    </select>
                  </div>

                  <div>
                    <label for="tournamentDate" class="block text-xs font-medium text-slate-300 mb-1.5">
                      Start Date
                    </label>
                    <input
                      id="tournamentDate"
                      type="date"
                      class="w-full rounded-xl bg-slate-900/90 border border-slate-600/70 focus:border-cyan-400 focus:ring-1 focus:ring-cyan-400/70 px-3 py-2 text-xs outline-none"
                    />
                  </div>
                </div>
              </div>
            </div>

            <!-- Teams card -->
            <div class="rounded-2xl bg-slate-900/70 border border-slate-700/80 shadow-xl shadow-cyan-500/5 p-4 sm:p-5">
              <h2 class="text-base sm:text-lg font-semibold mb-3 flex items-center justify-between">
                <span>Teams</span>
                <span id="teamCountBadge" class="text-xs px-2.5 py-0.5 rounded-full bg-slate-800/80 border border-slate-600/70 text-slate-300">
                  0 teams
                </span>
              </h2>

              <!-- Add team input -->
              <div class="flex gap-2 mb-3">
                <input
                  id="teamNameInput"
                  type="text"
                  placeholder="Enter team name & press +"
                  class="flex-1 rounded-xl bg-slate-900/90 border border-slate-600/70 focus:border-cyan-400 focus:ring-1 focus:ring-cyan-400/70 px-3 py-2 text-xs outline-none"
                />
                <button
                  id="addTeamBtn"
                  class="inline-flex items-center justify-center rounded-xl bg-cyan-400/90 hover:bg-cyan-300 text-slate-950 text-xs font-semibold px-3 py-2 shadow-brand-glow transition"
                  type="button"
                >
                  +
                </button>
              </div>

              <!-- Team list -->
              <div class="border border-slate-700/80 rounded-xl bg-slate-950/60 max-h-60 overflow-y-auto text-xs">
                <ul id="teamList" class="divide-y divide-slate-800/80">
                  <!-- Teams will be rendered here -->
                </ul>
              </div>

              <p class="mt-2 text-[11px] text-slate-400">
                Tip: For a good league format, use 4, 6, 8, 10, or 12 teams.
              </p>
            </div>
          </section>

          <!-- Right: Fixtures -->
          <section class="lg:col-span-3 space-y-4">
            <!-- Actions -->
            <div class="rounded-2xl bg-slate-900/70 border border-slate-700/80 shadow-xl shadow-cyan-500/5 p-4 sm:p-5 flex flex-wrap gap-3 items-center justify-between">
              <div>
                <h2 class="text-base sm:text-lg font-semibold">
                  Fixtures Engine
                </h2>
                <p class="text-xs text-slate-400">
                  Generate schedule, save to Firebase, and export as PDF.
                </p>
              </div>

              <div class="flex flex-wrap gap-2">
                <button
                  id="generateFixturesBtn"
                  class="inline-flex items-center justify-center rounded-xl bg-cyan-400/90 hover:bg-cyan-300 text-slate-950 text-xs font-semibold px-3 py-2 shadow-brand-glow transition"
                  type="button"
                >
                  Generate Fixtures
                </button>

                <button
                  id="saveFixturesBtn"
                  class="inline-flex items-center justify-center rounded-xl bg-emerald-400/90 hover:bg-emerald-300 text-slate-950 text-xs font-semibold px-3 py-2 transition"
                  type="button"
                  disabled
                >
                  Save to Firebase
                </button>

                <button
                  id="exportPdfBtn"
                  class="inline-flex items-center justify-center rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-100 text-xs font-semibold px-3 py-2 transition"
                  type="button"
                  disabled
                >
                  Export PDF
                </button>

                <button
                  id="clearAllBtn"
                  class="inline-flex items-center justify-center rounded-xl bg-red-500/90 hover:bg-red-400 text-slate-50 text-xs font-semibold px-3 py-2 transition"
                  type="button"
                >
                  Clear All
                </button>
              </div>
            </div>

            <!-- Fixtures table -->
            <div class="rounded-2xl bg-slate-900/70 border border-slate-700/80 shadow-xl shadow-cyan-500/5 p-4 sm:p-5">
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm sm:text-base font-semibold">
                  Generated Fixtures
                </h3>
                <span class="text-[11px] text-slate-400" id="fixtureCountLabel">
                  No fixtures yet
                </span>
              </div>

              <div class="border border-slate-800/80 rounded-xl overflow-hidden bg-slate-950/60">
                <div class="overflow-x-auto">
                  <table class="min-w-full text-xs" id="fixturesTable">
                    <thead class="bg-slate-900/80 text-slate-300 text-[11px] uppercase tracking-wide">
                      <tr>
                        <th class="px-3 py-2 text-left">Match</th>
                        <th class="px-3 py-2 text-left">Team A</th>
                        <th class="px-3 py-2 text-left">Team B</th>
                        <th class="px-3 py-2 text-left">Date/Time</th>
                        <th class="px-3 py-2 text-left">Status</th>
                      </tr>
                    </thead>
                    <tbody id="fixturesBody" class="divide-y divide-slate-800/80">
                      <!-- Fixtures rows injected here -->
                    </tbody>
                  </table>
                </div>
              </div>

              <p class="mt-2 text-[11px] text-slate-400">
                Once saved, you can share your public viewer link generated for this tournament.
              </p>

              <div id="publicLinkBox" class="hidden mt-3 text-[11px] bg-slate-950/80 border border-cyan-400/30 rounded-xl px-3 py-2 flex items-center justify-between gap-2">
                <span id="publicLink" class="truncate text-cyan-200"></span>
                <button
                  id="copyLinkBtn"
                  class="flex-shrink-0 text-[11px] px-2 py-1 rounded-lg bg-cyan-400/90 hover:bg-cyan-300 text-slate-950 font-semibold"
                  type="button"
                >
                  Copy
                </button>
              </div>
            </div>
          </section>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="border-t border-slate-800/60 bg-slate-950/60 text-[11px] text-slate-500">
      <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
        <span>Â© <span id="yearSpan"></span> PesPagol Tournament Platform</span>
        <span>Built for eFootball events</span>
      </div>
    </footer>
  </div>

  <!-- App script -->
  <script>
    // =========================
    //  Firebase Configuration
    // =========================
    // TODO: Replace with your real Firebase config
   const firebaseConfig = {
  apiKey: "AIzaSyBJmw5rvmN3DrDBUveGZlqHU3j-xmjKYSI",
  authDomain: "pes-tournament-e2a1a.firebaseapp.com",
  databaseURL: "https://pes-tournament-e2a1a-default-rtdb.firebaseio.com",
  projectId: "pes-tournament-e2a1a",
  storageBucket: "pes-tournament-e2a1a.firebasestorage.app",
  messagingSenderId: "966089960191",
  appId: "1:966089960191:web:bb61b49290e09585b27aca",
  measurementId: "G-YDWWJRZCNR"
};

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // =========================
    //  DOM Elements
    // =========================
    const statusMessage = document.getElementById("statusMessage");
    const yearSpan = document.getElementById("yearSpan");
    const teamNameInput = document.getElementById("teamNameInput");
    const addTeamBtn = document.getElementById("addTeamBtn");
    const teamList = document.getElementById("teamList");
    const teamCountBadge = document.getElementById("teamCountBadge");
    const generateFixturesBtn = document.getElementById("generateFixturesBtn");
    const saveFixturesBtn = document.getElementById("saveFixturesBtn");
    const exportPdfBtn = document.getElementById("exportPdfBtn");
    const clearAllBtn = document.getElementById("clearAllBtn");
    const fixturesBody = document.getElementById("fixturesBody");
    const fixtureCountLabel = document.getElementById("fixtureCountLabel");
    const publicLinkBox = document.getElementById("publicLinkBox");
    const publicLinkSpan = document.getElementById("publicLink");
    const copyLinkBtn = document.getElementById("copyLinkBtn");

    const tournamentNameInput = document.getElementById("tournamentName");
    const tournamentTypeInput = document.getElementById("tournamentType");
    const tournamentDateInput = document.getElementById("tournamentDate");

    // =========================
    //  State
    // =========================
    let teams = [];
    let fixtures = [];
    let lastTournamentId = null;

    // =========================
    //  Helpers
    // =========================
    function updateTeamCount() {
      teamCountBadge.textContent = `${teams.length} ${teams.length === 1 ? "team" : "teams"}`;
    }

    function renderTeams() {
      teamList.innerHTML = "";
      teams.forEach((team, index) => {
        const li = document.createElement("li");
        li.className = "flex items-center justify-between px-3 py-2 hover:bg-slate-900/70";
        li.innerHTML = `
          <span class="truncate">${index + 1}. ${team}</span>
          <button
            data-index="${index}"
            class="text-[11px] text-red-300 hover:text-red-200"
            type="button"
          >
            Remove
          </button>
        `;
        teamList.appendChild(li);
      });
      updateTeamCount();
    }

    function showStatus(message, type = "success") {
      statusMessage.textContent = message;
      statusMessage.classList.remove("hidden");
      statusMessage.classList.remove("border-emerald-400/40", "bg-emerald-500/10", "text-emerald-100");
      statusMessage.classList.remove("border-red-400/40", "bg-red-500/10", "text-red-100");

      if (type === "success") {
        statusMessage.classList.add("border-emerald-400/40", "bg-emerald-500/10", "text-emerald-100");
      } else {
        statusMessage.classList.add("border-red-400/40", "bg-red-500/10", "text-red-100");
      }

      setTimeout(() => {
        statusMessage.classList.add("hidden");
      }, 3500);
    }

    function resetFixturesTable() {
      fixturesBody.innerHTML = "";
      fixtures = [];
      fixtureCountLabel.textContent = "No fixtures yet";
      saveFixturesBtn.disabled = true;
      exportPdfBtn.disabled = true;
      publicLinkBox.classList.add("hidden");
    }

    function renderFixtures() {
      fixturesBody.innerHTML = "";
      fixtures.forEach((fx, idx) => {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-slate-900/60";
        tr.innerHTML = `
          <td class="px-3 py-2 whitespace-nowrap">#${idx + 1}</td>
          <td class="px-3 py-2 whitespace-nowrap">${fx.teamA}</td>
          <td class="px-3 py-2 whitespace-nowrap">${fx.teamB}</td>
          <td class="px-3 py-2 whitespace-nowrap text-slate-300 text-[11px]">${fx.datetime}</td>
          <td class="px-3 py-2 whitespace-nowrap text-[11px] text-slate-400">${fx.status}</td>
        `;
        fixturesBody.appendChild(tr);
      });

      if (fixtures.length === 0) {
        fixtureCountLabel.textContent = "No fixtures yet";
        saveFixturesBtn.disabled = true;
        exportPdfBtn.disabled = true;
      } else {
        fixtureCountLabel.textContent = `${fixtures.length} matches scheduled`;
        saveFixturesBtn.disabled = false;
        exportPdfBtn.disabled = false;
      }
    }

    function formatDateLabel(baseDate, incrementIndex) {
      if (!baseDate) {
        return "TBD";
      }
      const d = new Date(baseDate);
      if (Number.isFinite(incrementIndex)) {
        d.setDate(d.getDate() + incrementIndex);
      }
      const day = String(d.getDate()).padStart(2, "0");
      const month = String(d.getMonth() + 1).padStart(2, "0");
      const year = d.getFullYear();
      const hours = "20"; // fixed time 8 PM
      const minutes = "00";
      return `${day}-${month}-${year} ${hours}:${minutes}`;
    }

    function shuffleArray(arr) {
      const a = [...arr];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function generateLeagueFixtures(teamList, baseDate) {
      const res = [];
      let dayOffset = 0;
      for (let i = 0; i < teamList.length; i++) {
        for (let j = i + 1; j < teamList.length; j++) {
          res.push({
            teamA: teamList[i],
            teamB: teamList[j],
            datetime: formatDateLabel(baseDate, dayOffset),
            status: "Scheduled"
          });
          dayOffset++;
        }
      }
      return res;
    }

    function generateKnockoutFixtures(teamList, baseDate) {
      const shuffled = shuffleArray(teamList);
      const res = [];
      if (shuffled.length % 2 !== 0) {
        shuffled.push("BYE");
      }
      let dayOffset = 0;
      for (let i = 0; i < shuffled.length; i += 2) {
        const a = shuffled[i];
        const b = shuffled[i + 1];
        res.push({
          teamA: a,
          teamB: b,
          datetime: formatDateLabel(baseDate, dayOffset),
          status: b === "BYE" || a === "BYE" ? "Bye Round" : "Scheduled"
        });
        dayOffset++;
      }
      return res;
    }

    function exportFixturesToPdf() {
      if (!fixtures.length) {
        showStatus("No fixtures available to export.", "error");
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const title = tournamentNameInput.value || "PesPagol Tournament Fixtures";
      doc.setFont("helvetica", "bold");
      doc.setFontSize(14);
      doc.text(title, 10, 15);

      const subtitle = `Format: ${tournamentTypeInput.value.toUpperCase()}`;
      doc.setFontSize(10);
      doc.setFont("helvetica", "normal");
      doc.text(subtitle, 10, 22);

      let y = 30;
      doc.setFontSize(9);
      doc.setFont("helvetica", "bold");
      doc.text("Match", 10, y);
      doc.text("Team A", 28, y);
      doc.text("Team B", 80, y);
      doc.text("Date/Time", 132, y);
      doc.text("Status", 175, y);
      doc.setFont("helvetica", "normal");

      y += 6;

      fixtures.forEach((fx, idx) => {
        if (y > 280) {
          doc.addPage();
          y = 20;
        }
        doc.text(`#${idx + 1}`, 10, y);
        doc.text(String(fx.teamA), 28, y);
        doc.text(String(fx.teamB), 80, y);
        doc.text(String(fx.datetime), 132, y);
        doc.text(String(fx.status), 175, y);
        y += 6;
      });

      const safeName = (tournamentNameInput.value || "pespagol-fixtures")
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, "-");
      doc.save(`${safeName}.pdf`);
    }

    function generateUniqueTournamentId() {
      const timestamp = Date.now();
      const randomPart = Math.floor(Math.random() * 9999);
      return `t_${timestamp}_${randomPart}`;
    }

    function saveToFirebase() {
      if (!fixtures.length) {
        showStatus("Generate fixtures before saving.", "error");
        return;
      }
      const name = tournamentNameInput.value.trim();
      if (!name) {
        showStatus("Please enter a tournament name.", "error");
        return;
      }

      const format = tournamentTypeInput.value || "league";
      const startDate = tournamentDateInput.value || null;

      const tournamentId = generateUniqueTournamentId();
      lastTournamentId = tournamentId;

      const payload = {
        id: tournamentId,
        name,
        format,
        startDate,
        teams,
        fixtures,
        createdAt: new Date().toISOString()
      };

      db.ref(`tournaments/${tournamentId}`)
        .set(payload)
        .then(() => {
          showStatus("Tournament saved successfully in Firebase.", "success");
          const publicUrl = `${window.location.origin}/view.html?t=${encodeURIComponent(tournamentId)}`;
          publicLinkSpan.textContent = publicUrl;
          publicLinkSpan.setAttribute("data-url", publicUrl);
          publicLinkBox.classList.remove("hidden");
        })
        .catch((err) => {
          console.error(err);
          showStatus("Error saving to Firebase: " + err.message, "error");
        });
    }

    // =========================
    //  Event Listeners
    // =========================
    yearSpan.textContent = new Date().getFullYear();

    addTeamBtn.addEventListener("click", () => {
      const val = teamNameInput.value.trim();
      if (!val) return;
      if (teams.includes(val)) {
        showStatus("This team is already added.", "error");
        return;
      }
      teams.push(val);
      teamNameInput.value = "";
      renderTeams();
    });

    teamNameInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        addTeamBtn.click();
      }
    });

    teamList.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-index]");
      if (!btn) return;
      const index = Number(btn.getAttribute("data-index"));
      teams.splice(index, 1);
      renderTeams();
    });

    generateFixturesBtn.addEventListener("click", () => {
      if (teams.length < 2) {
        showStatus("At least 2 teams are required to generate fixtures.", "error");
        return;
      }
      const baseDate = tournamentDateInput.value || null;
      const format = tournamentTypeInput.value || "league";

      let generated = [];
      if (format === "league") {
        generated = generateLeagueFixtures(teams, baseDate);
      } else {
        generated = generateKnockoutFixtures(teams, baseDate);
      }

      fixtures = generated;
      renderFixtures();
      showStatus("Fixtures generated successfully.", "success");
    });

    saveFixturesBtn.addEventListener("click", saveToFirebase);

    exportPdfBtn.addEventListener("click", () => {
      exportFixturesToPdf();
    });

    clearAllBtn.addEventListener("click", () => {
      if (!confirm("Clear teams and fixtures?")) return;
      teams = [];
      resetFixturesTable();
      renderTeams();
      tournamentNameInput.value = "";
      tournamentDateInput.value = "";
      showStatus("Cleared tournament data.", "success");
    });

    copyLinkBtn.addEventListener("click", () => {
      const url = publicLinkSpan.getAttribute("data-url") || publicLinkSpan.textContent;
      if (!url) return;

      navigator.clipboard.writeText(url).then(
        () => {
          showStatus("Public link copied to clipboard.", "success");
        },
        () => {
          showStatus("Unable to copy link automatically.", "error");
        }
      );
    });
  </script>
</body>
</html>
